<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Android Oat,">










<meta name="description" content=".oatdata -&amp;gt; .rodata(oatHeader、dex文件相关信息、dex原始文件、类中方法与翻译为native code的对应关系).oatexec -&amp;gt; .text(native code) Oat文件结构概览：  elf文件结构(32位)：12345typedef uint16_t Elf32_Half; //2 bytestypedef uint32_t Elf32">
<meta name="keywords" content="Android Oat">
<meta property="og:type" content="article">
<meta property="og:title" content="Android Oat文件分析">
<meta property="og:url" content="http://yoursite.com/2018/12/26/Oat文件分析/index.html">
<meta property="og:site_name" content="Heinz Blog">
<meta property="og:description" content=".oatdata -&amp;gt; .rodata(oatHeader、dex文件相关信息、dex原始文件、类中方法与翻译为native code的对应关系).oatexec -&amp;gt; .text(native code) Oat文件结构概览：  elf文件结构(32位)：12345typedef uint16_t Elf32_Half; //2 bytestypedef uint32_t Elf32">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://note.youdao.com/yws/api/personal/file/WEBd91be5da5cc9c70b50ac5355d12d6e84?method=download&shareKey=cfbfd9c6f94f41b648fc4d3b4ebacadb">
<meta property="og:updated_time" content="2018-12-27T13:55:00.968Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android Oat文件分析">
<meta name="twitter:description" content=".oatdata -&amp;gt; .rodata(oatHeader、dex文件相关信息、dex原始文件、类中方法与翻译为native code的对应关系).oatexec -&amp;gt; .text(native code) Oat文件结构概览：  elf文件结构(32位)：12345typedef uint16_t Elf32_Half; //2 bytestypedef uint32_t Elf32">
<meta name="twitter:image" content="https://note.youdao.com/yws/api/personal/file/WEBd91be5da5cc9c70b50ac5355d12d6e84?method=download&shareKey=cfbfd9c6f94f41b648fc4d3b4ebacadb">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/12/26/Oat文件分析/">





  <title>Android Oat文件分析 | Heinz Blog</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Heinz Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">记录每一段岁月的美好！</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/26/Oat文件分析/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Heinz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Heinz Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">Android Oat文件分析</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-26T11:35:56+08:00">
                2018-12-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/12/26/Oat文件分析/" class="leancloud_visitors" data-flag-title="Android Oat文件分析">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>.oatdata -&gt; .rodata(oatHeader、dex文件相关信息、dex原始文件、类中方法与翻译为native code的对应关系)<br>.oatexec -&gt; .text(native code)</p>
<p>Oat文件结构概览：</p>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEBd91be5da5cc9c70b50ac5355d12d6e84?method=download&amp;shareKey=cfbfd9c6f94f41b648fc4d3b4ebacadb" alt="avatar"></p>
<h1 id="elf文件结构-32位-："><a href="#elf文件结构-32位-：" class="headerlink" title="elf文件结构(32位)："></a>elf文件结构(32位)：</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">typedef uint16_t Elf32_Half; //2 bytes</span><br><span class="line">typedef uint32_t Elf32_Word; //4 bytes</span><br><span class="line">typedef uint32_t Elf32_Addr; //4 bytes</span><br><span class="line">typedef uint32_t Elf32_Off;  //4 bytes</span><br><span class="line">typedef int32_t  Elf32_Sword;//4 bytes</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// Object file magic string.</span><br><span class="line">static const char ElfMagic[] = &#123; 0x7f, &apos;E&apos;, &apos;L&apos;, &apos;F&apos;, &apos;\0&apos; &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// e_ident size and indices.</span><br><span class="line">enum &#123;</span><br><span class="line">  EI_MAG0       = 0,          // File identification index.</span><br><span class="line">  EI_MAG1       = 1,          // File identification index.</span><br><span class="line">  EI_MAG2       = 2,          // File identification index.</span><br><span class="line">  EI_MAG3       = 3,          // File identification index.</span><br><span class="line">  EI_CLASS      = 4          ,// File class.</span><br><span class="line">  EI_DATA       = 5,          // Data encoding.</span><br><span class="line">  EI_VERSION    = 6,          // File version.</span><br><span class="line">  EI_OSABI      = 7,          // OS/ABI identification.</span><br><span class="line">  EI_ABIVERSION = 8,          // ABI version.</span><br><span class="line">  EI_PAD        = 9,          // Start of padding bytes.</span><br><span class="line">  EI_NIDENT     = 16          // Number of bytes in e_ident.</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>elf文件头结构：（16+4+20+12=52字节，1+2+5+6=14项）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">struct Elf32_Ehdr&#123;</span><br><span class="line">    unsigned char e_ident[EI_NIDENT];//ELF文件魔数          16字节</span><br><span class="line">    Elf32_Half  e_type;              //ELF文件类型（32/64位）2字节  2*2</span><br><span class="line">    Elf32_Half  e_machine;           //该ELF文件所需要的架构  2字节</span><br><span class="line">    Elf32_Word  e_version;           //ELF文件版本（始终为1） 4字节   4*5</span><br><span class="line">    Elf32_Addr  e_entry;             //程序入口地址          4字节</span><br><span class="line">    Elf32_Off   e_phoff;             //segment表偏移地址     4字节</span><br><span class="line">    Elf32_Off   e_shoff;             //section表偏移地址     4字节</span><br><span class="line">    Elf32_Word  e_flags;             //标志                 4字节</span><br><span class="line">    Elf32_Half  e_ehsize;            //ELF文件头大小         2字节   2*6</span><br><span class="line">    Elf32_Half  e_phentsize;        //segment表项大小        2字节</span><br><span class="line">    Elf32_Half  e_phnum;            //segment表项数目        2字节</span><br><span class="line">    Elf32_Half  e_shentsize;        //section表项大小        2字节  </span><br><span class="line">    Elf32_Half  e_shnum;            //section表项数目        2字节</span><br><span class="line">    Elf32_Half  e_shstrndx;         //段表字符串表在section表中的下标 2字节</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// File types</span><br><span class="line">enum &#123;</span><br><span class="line">  ET_NONE   = 0,      // No file type</span><br><span class="line">  ET_REL    = 1,      // Relocatable file</span><br><span class="line">  ET_EXEC   = 2,      // Executable file</span><br><span class="line">  ET_DYN    = 3,      // Shared object file</span><br><span class="line">  ET_CORE   = 4,      // Core file</span><br><span class="line">  ET_LOPROC = 0xff00, // Beginning of processor-specific codes</span><br><span class="line">  ET_HIPROC = 0xffff  // Processor-specific</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// Machine architectures</span><br><span class="line">enum &#123;</span><br><span class="line">    EM_NONE = 0, // No machine</span><br><span class="line">    EM_ARM  = 40 // ARM</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>案例分析①：data@<a href="mailto:app@com.example.passerby.myapplication.app-1" target="_blank" rel="noopener">app@com.example.passerby.myapplication.app-1</a>@<a href="mailto:base.apk@classes.dex" target="_blank" rel="noopener">base.apk@classes.dex</a></p>
<blockquote>
<p>7F 45 4C 46 01 01 01 03 00 00 00 00 00 00 00 00<br>03 00 28 00 01 00 00 00 00 00 00 00 34 00 00 00<br>70 50 48 00 00 00 00 05 34 00 20 00 05 00 28 00<br>08 00 07 00</p>
</blockquote>
<p>魔数：7F 45 4C 46 //0x464c457f<br>位宽：01 //0x01代表32位；0x02代表64位<br>端序：01 //0x01代表小端；0x02代表打断<br>版本：01<br>操作系统：03 //0x03代表Linux<br>00 00 00 00 00 00 00 00<br>文件类型：03 00  //0x03:共享文件<br>芯片架构：28 00 // 0x28 ARM架构<br>文件版本：01 00 00 00 //0x01 (始终为1)<br>程序入口地址：00 00 00 00 //0x0<br>segment表偏移：34 00 00 00 //0x34<br>section表偏移：70 50 48 00 //0x485070<br>标志：00 00 00 05   //0x5000000<br>文件头大小：34 00   //0x34<br>segment表项大小：20 00  //0x20<br>segment表项数目：05 00  //0x05<br>section表项大小：28 00  //0x28<br>section表项数目：08 00  //0x08<br>段表字符串表在段表中下标：07 00 //0x07</p>
<hr>
<p>segment头结构：（8项，每项4个字节，32字节）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">struct Elf32_Phdr&#123;</span><br><span class="line">    Elf32_Word  p_type;//segment类型</span><br><span class="line">    Elf32_Off   p_offset;//segment相对文件开始的偏移</span><br><span class="line">    Elf32_Addr  p_vaddr;//segment映射到内存中的首字节地址（即虚拟地址）</span><br><span class="line">    Elf32_Addr  p_paddr;//在物理地址定位有关的系统中，该字段是为该段的物理地址而保留的，对于可执行文件和共享的object而言是未指定内容的。</span><br><span class="line">    Elf32_Word  p_filesz;//在文件映像中该segment的字节数（可能是0）</span><br><span class="line">    Elf32_Word  p_memsz;//在内存映像中该segment的字节数（可能是0）</span><br><span class="line">    Elf32_Word  p_flags;//segment标志</span><br><span class="line">    Elf32_Word  p_align;//可载入的进程段必须有合适的p_vaddr、p_offset值，取页面大小的模。该字段给出了该段在内存和文件中排列值。0和1表示不需要排列。否则，p_align必须为正的2的幂</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// Segment types.</span><br><span class="line">enum &#123;</span><br><span class="line">    PT_NULL    = 0, // Unused segment.空值</span><br><span class="line">    PT_LOAD    = 1, // Loadable segment.加载到内存中</span><br><span class="line">    PT_DYNAMIC = 2, // Dynamic linking information.动态链接</span><br><span class="line">    PT_INTERP  = 3, // Interpreter pathname.动态链接的辅助信息</span><br><span class="line">    PT_NOTE    = 4, // Auxiliary information.其他信息</span><br><span class="line">    PT_SHLIB   = 5, // Reserved.RFU</span><br><span class="line">    PT_PHDR    = 6, // The program header table itself.segment表头的位置和大小</span><br><span class="line">    PT_TLS     = 7, // The thread-local storage template.</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>案例分析②：data@<a href="mailto:app@com.example.passerby.myapplication.app-1" target="_blank" rel="noopener">app@com.example.passerby.myapplication.app-1</a>@<a href="mailto:base.apk@classes.dex" target="_blank" rel="noopener">base.apk@classes.dex</a></p>
<p>由ELF文件头知：segment表偏移为0x34;表大小为0x05;表项大小为0x20;推出segment头表大小为：0x05*0x20=0xa0 </p>
<blockquote>
<p>06 00 00 00 34 00 00 00 34 00 00 00 34 00 00 00 //PT_PHDR<br>A0 00 00 00 A0 00 00 00 04 00 00 00 04 00 00 00<br>01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 //PT_LOAD<br>00 10 2A 00 00 10 2A 00 04 00 00 00 00 10 00 00<br>01 00 00 00 00 10 2A 00 00 10 2A 00 00 10 2A 00 //PT_LOAD<br>48 35 1E 00 48 35 1E 00 05 00 00 00 00 10 00 00<br>01 00 00 00 00 50 48 00 00 50 48 00 00 50 48 00 //PT_LOAD<br>38 00 00 00 38 00 00 00 06 00 00 00 00 10 00 00<br>02 00 00 00 00 50 48 00 00 50 48 00 00 50 48 00 //PT_DYNAMIC<br>38 00 00 00 38 00 00 00 06 00 00 00 00 10 00 00   </p>
</blockquote>
<p>第一个segment头：<br>06 00 00 00 34 00 00 00 34 00 00 00 34 00 00 00<br>A0 00 00 00 A0 00 00 00 04 00 00 00 04 00 00 00<br>segment类型：06 00 00 00    //PT_PHDR(程序头表自身)<br>segment文件偏移：34 00 00 00<br>segment虚拟地址：34 00 00 00<br>segment物理地址：34 00 00 00<br>文件映像中该segment字节数：A0 00 00 00<br>内存映像中该segment字节数：A0 00 00 00<br>segment标志：04 00 00 00<br>segment对齐：04 00 00 00</p>
<p>其他segment头:<br>省略…</p>
<p>section头结构：（10项，每项4个字节，40字节）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">struct Elf32__Shdr&#123;</span><br><span class="line">  Elf32_Word sh_name;      // Section name (index into string table), section名字，string table的索引</span><br><span class="line">  Elf32_Word sh_type;      // Section type (SHT_*),section的类型</span><br><span class="line">  Elf32_Word sh_flags;     // Section flags (SHF_*),section标记，用来描述多个属性</span><br><span class="line">  Elf32_Addr sh_addr;      // Address where section is to be loaded,若该section被加载到内存中，该字段表示其在内存中的位置</span><br><span class="line">  Elf32_Off  sh_offset;    // File offset of section data, in bytes,该section在文件中的偏移，SHT_NOBITS类型的section在文件中不占用空间，概念上的位置</span><br><span class="line">  Elf32_Word sh_size;      // Size of section, in bytes,section大小，SHT_NOBITS类型的section该值可能为非0，但是不占文件空间</span><br><span class="line">  Elf32_Word sh_link;      // Section type-specific header table index link,到section头表的链接</span><br><span class="line">  Elf32_Word sh_info;      // Section type-specific extra information,额外信息</span><br><span class="line">  Elf32_Word sh_addralign; // Section address alignment,地址对齐</span><br><span class="line">  Elf32_Word sh_entsize;   // Size of records contained within the section,一些sections保留着一张固定大小入口的表，对于此类型的section，该字段给除了每个入口的字节大小</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// Section types.</span><br><span class="line">enum &#123;</span><br><span class="line">    SHT_NULL          = 0,  // No associated section (inactive entry).</span><br><span class="line">    SHT_PROGBITS      = 1,  // Program-defined contents.</span><br><span class="line">    SHT_SYMTAB        = 2,  // Symbol table. 符号表</span><br><span class="line">    SHT_STRTAB        = 3,  // String table. 字符串表</span><br><span class="line">    SHT_RELA          = 4,  // Relocation entries; explicit addends.</span><br><span class="line">    SHT_HASH          = 5,  // Symbol hash table.</span><br><span class="line">    SHT_DYNAMIC       = 6,  // Information for dynamic linking.</span><br><span class="line">    SHT_NOTE          = 7,  // Information about the file.</span><br><span class="line">    SHT_NOBITS        = 8,  // Data occupies no space in the file.</span><br><span class="line">    SHT_REL           = 9,  // Relocation entries; no explicit addends.</span><br><span class="line">    SHT_SHLIB         = 10, // Reserved.</span><br><span class="line">    SHT_DYNSYM        = 11, // Symbol table.  动态符号表</span><br><span class="line">    SHT_INIT_ARRAY    = 14, // Pointers to initialization functions.</span><br><span class="line">    SHT_FINI_ARRAY    = 15, // Pointers to termination functions.</span><br><span class="line">    SHT_PREINIT_ARRAY = 16, // Pointers to pre-init functions.</span><br><span class="line">    SHT_GROUP         = 17, // Section group.</span><br><span class="line">    SHT_SYMTAB_SHNDX  = 18, // Indices for SHN_XINDEX entries</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>案例分析③：data@<a href="mailto:app@com.example.passerby.myapplication.app-1" target="_blank" rel="noopener">app@com.example.passerby.myapplication.app-1</a>@<a href="mailto:base.apk@classes.dex" target="_blank" rel="noopener">base.apk@classes.dex</a><br>由ELF文件头知：section表偏移为0x485070;表项大小为0x28;表项数目为0x08;推出section头表大小为0x28*0x08=0x140</p>
<blockquote>
<p>00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00<br>00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00<br>00 00 00 00 00 00 00 00 01 00 00 00 0B 00 00 00<br>02 00 00 00 D4 00 00 00 D4 00 00 00 40 00 00 00<br>02 00 00 00 00 00 00 00 04 00 00 00 10 00 00 00<br>09 00 00 00 03 00 00 00 02 00 00 00 14 01 00 00<br>14 01 00 00 64 00 00 00 00 00 00 00 00 00 00 00<br>01 00 00 00 01 00 00 00 11 00 00 00 05 00 00 00<br>02 00 00 00 78 01 00 00 78 01 00 00 20 00 00 00<br>01 00 00 00 00 00 00 00 04 00 00 00 04 00 00 00<br>17 00 00 00 01 00 00 00 02 00 00 00 00 10 00 00<br>00 10 00 00 00 00 2A 00 00 00 00 00 00 00 00 00<br>00 10 00 00 00 00 00 00 1F 00 00 00 01 00 00 00<br>06 00 00 00 00 10 2A 00 00 10 2A 00 48 35 1E 00<br>00 00 00 00 00 00 00 00 00 10 00 00 00 00 00 00<br>25 00 00 00 06 00 00 00 02 00 00 00 00 50 48 00<br>00 50 48 00 38 00 00 00 01 00 00 00 00 00 00 00<br>00 10 00 00 08 00 00 00 2E 00 00 00 03 00 00 00<br>00 00 00 00 00 00 00 00 38 50 48 00 38 00 00 00<br>00 00 00 00 00 00 00 00 01 00 00 00 01 00 00 00   </p>
</blockquote>
<p>第一个section头：//No associated section (inactive entry).   </p>
<blockquote>
<p>00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00<br>00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00<br>00 00 00 00 00 00 00 00</p>
</blockquote>
<p>第二个section头：(.dynsym) //Symbol table    </p>
<blockquote>
<p>01 00 00 00 0B 00 00 00<br>02 00 00 00 D4 00 00 00 D4 00 00 00 40 00 00 00<br>02 00 00 00 00 00 00 00 04 00 00 00 10 00 00 00   </p>
</blockquote>
<p>section名称：01 00 00 00    //在字符串表中的下标<br>section类型：0B 00 00 00    //0xb 符号表 .symbol    </p>
<p>第三个section头：(.dynstr)</p>
<blockquote>
<p>09 00 00 00 03 00 00 00 02 00 00 00 14 01 00 00<br>14 01 00 00 64 00 00 00 00 00 00 00 00 00 00 00<br>01 00 00 00 01 00 00 00   </p>
</blockquote>
<p>section名称：09 00 00 00<br>section类型：03 00 00 00    //0x3 字符串表 .strtab<br>section标记：02 00 00 00<br>section虚拟地址：14 01 00 00<br>section文件偏移：14 01 00 00 //0x0114<br>section大小：64 00 00 00   //0x64 推出结束偏移：0x178<br>section到section头表的链接：00 00 00 00<br>section额外信息：00 00 00 00<br>section对齐：01 00 00 00<br>section入口表大小：01 00 00 00    </p>
<p>根据section头信息，导出.dynstr内容：    </p>
<blockquote>
<p>00 6F 61 74 64 61 74 61 00 6F 61 74 65 78 65 63<br>00 6F 61 74 6C 61 73 74 77 6F 72 64 00 64 61 74<br>61 40 61 70 70 40 63 6F 6D 2E 65 78 61 6D 70 6C<br>65 2E 70 61 73 73 65 72 62 79 2E 6D 79 61 70 70<br>6C 69 63 61 74 69 6F 6E 2E 61 70 70 2D 31 40 62<br>61 73 65 2E 61 70 6B 40 63 6C 61 73 73 65 73 2E<br>64 65 78 00</p>
</blockquote>
<p>对应的字符信息：<br>索引  |  值<br>—|:–:<br>0x0  |  \00<br>0x1  | oatdata\00<br>0x9  | oatexec\00<br>0x11 | oatlastword\00<br>0x1d | data@<a href="mailto:app@com.example.passerby.myapplication.app-1" target="_blank" rel="noopener">app@com.example.passerby.myapplication.app-1</a>@<a href="mailto:base.apk@classes.dex" target="_blank" rel="noopener">base.apk@classes.dex</a>\00</p>
<p>第四个section头：(.hash)</p>
<blockquote>
<p>11 00 00 00 05 00 00 00<br>02 00 00 00 78 01 00 00 78 01 00 00 20 00 00 00<br>01 00 00 00 00 00 00 00 04 00 00 00 04 00 00 00   </p>
</blockquote>
<p>section名称：11 00 00 00<br>section类型：05 00 00 00    //0x5 符号hash表    </p>
<p>第五个section头：(.rodata)  [原dex信息,oatdata] [oat文件头起始位置]   </p>
<blockquote>
<p>17 00 00 00 01 00 00 00 02 00 00 00 00 10 00 00<br>00 10 00 00 00 00 2A 00 00 00 00 00 00 00 00 00<br>00 10 00 00 00 00 00 00 </p>
</blockquote>
<p>section名称：17 00 00 00<br>section类型：01 00 00 00    //0x1 Program-defined contents<br>section标记：02 00 00 00<br>section虚拟地址：00 10 00 00<br>section文件偏移：00 10 00 00    //0x1000<br>section大小：00 00 2A 00        //0x2A0000 推出结束偏移：0x2A1000<br>section到section头表的链接：00 00 00 00<br>section额外信息：00 00 00 00<br>section对齐：00 10 00 00<br>section入口表大小：00 00 00 00    </p>
<p>依据section头，导出.rodata内容：<br>[rodata.txt]</p>
<p>第六个section头：(.text) [native code,oatexec]    </p>
<blockquote>
<p>1F 00 00 00 01 00 00 00<br>06 00 00 00 00 10 2A 00 00 10 2A 00 48 35 1E 00<br>00 00 00 00 00 00 00 00 00 10 00 00 00 00 00 00  </p>
</blockquote>
<p>section名称：1F 00 00 00<br>section类型：01 00 00 00    //0x1 Program-defined contents<br>section标记：06 00 00 00<br>section虚拟地址：00 10 2A 00<br>section文件偏移：00 10 2A 00    //0x2A1000<br>section大小：48 35 1E 00        //0x1E3548 推出结束偏移：0x484548<br>section到section头表的链接：00 00 00 00<br>section额外信息：00 00 00 00<br>section对齐：00 10 00 00<br>section入口表大小：00 00 00 00    </p>
<p>依据section头信息，导出.text内容：<br>[text.txt]</p>
<p><strong>.text段 与 .dynamic段之间有一段空区域</strong></p>
<p>第七个section头：(.dynamic)      </p>
<blockquote>
<p>25 00 00 00 06 00 00 00 02 00 00 00 00 50 48 00<br>00 50 48 00 38 00 00 00 01 00 00 00 00 00 00 00<br>00 10 00 00 08 00 00 00     </p>
</blockquote>
<p>section名称：25 00 00 00<br>section类型：06 00 00 00    //Information for dynamic linking<br>section标记：02 00 00 00<br>section虚拟地址：00 50 48 00<br>section文件偏移：00 50 48 00    //0x485000<br>section大小：38 00 00 00        //0x38 推出结束偏移：0x485038<br>section到section头表的链接：01 00 00 00<br>section额外信息：00 00 00 00<br>section对齐：00 10 00 00<br>section入口表大小：08 00 00 00    </p>
<p>第八个section头：(.shstrtab)：<br>由ELF文件头知：shstrtab在section头表总的下标为0x07,在本案例中即最后一个section </p>
<blockquote>
<p>2E 00 00 00 03 00 00 00<br>00 00 00 00 00 00 00 00 38 50 48 00 38 00 00 00<br>00 00 00 00 00 00 00 00 01 00 00 00 01 00 00 00   </p>
</blockquote>
<p>section名称：2E 00 00 00<br>section类型：03 00 00 00    //字符串表（段表字符串表）<br>section标记：00 00 00 00<br>section虚拟地址：00 00 00 00<br>section文件偏移：38 50 48 00    //0x485038<br>section大小：38 00 00 00        //0x38 推出结束偏移：0x485070<br>section到section头表的链接：00 00 00 00<br>section额外信息：00 00 00 00<br>section对齐：01 00 00 00<br>section入口表大小：01 00 00 00    </p>
<p>依据section头信息，导出.shstrtab内容：    </p>
<blockquote>
<p>00 2E 64 79 6E 73 79 6D 00 2E 64 79 6E 73 74 72<br>00 2E 68 61 73 68 00 2E 72 6F 64 61 74 61 00 2E<br>74 65 78 74 00 2E 64 79 6E 61 6D 69 63 00 2E 73<br>68 73 74 72 74 61 62 00</p>
</blockquote>
<p>对应的字符信息：<br>索引  |  值<br>—|:–:<br>0x0  |  \00<br>0x01 |  .dynsym\00<br>0x09 |  .dynstr\00<br>0x11 |  .hash\00<br>0x17 |  .rodata\00<br>0x1f |  .text\00<br>0x25 |  .dynamic\00<br>0x2e |  .shstrtab\00</p>
<hr>
<p>oat文件头结构：/art/runtime/oat.h<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">class PACKED(4) OatHeader &#123;</span><br><span class="line">    ...</span><br><span class="line"> private:</span><br><span class="line">  ...</span><br><span class="line">  uint8_t magic_[4];    //魔数‘oat\n’</span><br><span class="line">  uint8_t version_[4];  //oat文件版本号</span><br><span class="line">  uint32_t adler32_checksum_;   //校验和</span><br><span class="line"></span><br><span class="line">  InstructionSet instruction_set_;  //本地机器指令集，表示指令的类型（枚举类型）/art/runtime/instruction_set.h</span><br><span class="line">  InstructionSetFeatures instruction_set_features_; //架构特性</span><br><span class="line">  uint32_t dex_file_count_; //oat文件包含的dex文件个数</span><br><span class="line">  uint32_t executable_offset_;  //oatexec段开始位置与oatdata段开始位置的偏移值（oatexec段开始位置+executable_offset_=oatdata段开始位置）</span><br><span class="line"></span><br><span class="line">  uint32_t interpreter_to_interpreter_bridge_offset_;   //用来从解释器调用另外一个也是通过解释器来执行的类方法的trampoline代码的偏移位置</span><br><span class="line">  uint32_t interpreter_to_compiled_code_bridge_offset_; //用来从解释器调用另外一个通过本地机器指令执行的类方法的trampoline代码的偏移位置</span><br><span class="line">  uint32_t jni_dlsym_lookup_offset_;    //类方法在执行过程中，若被调用的方法是JNI函数，那么通过存放在此位置的trampoline代码来调用</span><br><span class="line">  uint32_t portable_imt_conflict_trampoline_offset_;    //...</span><br><span class="line">  uint32_t portable_resolution_trampoline_offset_;  //用来在运行时解析还未链接的类方法的trampoline代码位置（portable类型的机器指令）</span><br><span class="line">  uint32_t portable_to_interpreter_bridge_offset_;  //用来从本地机器指令（portable类型）调用另外一个通过解释器解释执行的类方法的trampoline代码的偏移位置</span><br><span class="line">  uint32_t quick_generic_jni_trampoline_offset_;    //...</span><br><span class="line">  uint32_t quick_imt_conflict_trampoline_offset_;   //...</span><br><span class="line">  uint32_t quick_resolution_trampoline_offset_; //用来在运行时解析还未链接的类方法的trampoline代码位置（quick类型的机器指令）</span><br><span class="line">  uint32_t quick_to_interpreter_bridge_offset_;  //用来从本地机器指令（quick类型）调用另外一个通过解释器解释执行的类方法的trampoline代码的偏移位置</span><br><span class="line"></span><br><span class="line">  //由于每一个应用程序都会依赖于boot.art文件，上述10个变量指向的trampoline代码段只存在于boot.art文件中，即在应用程序classes.dex生成的oat文件的oatdata段头部，上述变量值均为0</span><br><span class="line"></span><br><span class="line">  // The amount that the image this oat is associated with has been patched.</span><br><span class="line">  int32_t image_patch_delta_;   //该oat文件关联的image被patch的数量</span><br><span class="line"></span><br><span class="line">  uint32_t image_file_location_oat_checksum_;   //用来创建image空间的oat文件的校验和</span><br><span class="line">  uint32_t image_file_location_oat_data_begin_; //用来创建image空间的oat文件的oatdata段在内存的位置</span><br><span class="line"></span><br><span class="line">  uint32_t key_value_store_size_;   //用来创建image空间的文件路径的大小</span><br><span class="line">  uint8_t key_value_store_[0];  // note variable width data at end</span><br><span class="line"></span><br><span class="line">  DISALLOW_COPY_AND_ASSIGN(OatHeader);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// InstructionSet</span><br><span class="line">enum InstructionSet &#123;</span><br><span class="line">  kNone,</span><br><span class="line">  kArm,</span><br><span class="line">  kArm64,</span><br><span class="line">  kThumb2,</span><br><span class="line">  kX86,</span><br><span class="line">  kX86_64,</span><br><span class="line">  kMips,</span><br><span class="line">  kMips64</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>案例分析④：data@<a href="mailto:app@com.example.passerby.myapplication.app-1" target="_blank" rel="noopener">app@com.example.passerby.myapplication.app-1</a>@<a href="mailto:base.apk@classes.dex" target="_blank" rel="noopener">base.apk@classes.dex</a></p>
<p>开始位置：0x1000<br>由rodata.txt中的数据及oat文件头结构知：<br>魔数：6F 61 74 0A   //大端序，0x6f61740a<br>版本号：30 33 39 00 //大端序，0x30333900<br>校验和：E4 E3 11 75<br>指令类型：03 00 00 00<br>指令集特性：01 00 00 00<br>包含的dex文件个数：01 00 00 00<br>oatexec段开始位置相对于oatdata段开始位置的偏移：00 00 2A 00<br>解释器执行到解释器执行的trampoline代码的偏移位置：00 00 00 00<br>解释器执行到本地机器指令执行的trampoline代码的偏移位置：00 00 00 00<br>JNI方法调用的trampoline代码的偏移位置：00 00 00 00<br>portable_imt_conflict_trampoline_offset_：00 00 00 00<br>本地机器指令（portable）执行解析未链接的方法的trampoline代码的偏移位置：00 00 00 00<br>本地机器指令（portable）执行到解释器执行的trampoline代码的偏移位置：00 00 00 00<br>quick_generic_jni_trampoline_offset_：00 00 00 00<br>quick_imt_conflict_trampoline_offset_：00 00 00 00<br>本地机器指令（quick）执行解析未链接的方法的trampoline代码的偏移位置：00 00 00 00<br>本地机器指令（quick）执行到解释器执行的trampoline代码的偏移位置：00 00 00 00<br>image_patch_delta_：00 00 00 00<br>创建image空间的oat文件的校验和：8E 72 EE 60<br>创建image空间的oat文件的oatdata段在内存的位置：00 F0 17 71<br>key_value_store_size_：A6 01 00 00<br>key_value_store_：(dex2oat的参数)   </p>
<p>依据key_value_store_size_导出key_value_store_的内容：   </p>
<blockquote>
<p>64 65 78 32 6F 61 74 2D 63 6D 64 6C 69 6E 65 00<br>2D 2D 7A 69 70 2D 66 64 3D 36 20 2D 2D 7A 69 70<br>2D 6C 6F 63 61 74 69 6F 6E 3D 2F 64 61 74 61 2F<br>61 70 70 2F 63 6F 6D 2E 65 78 61 6D 70 6C 65 2E<br>70 61 73 73 65 72 62 79 2E 6D 79 61 70 70 6C 69<br>63 61 74 69 6F 6E 2E 61 70 70 2D 31 2F 62 61 73<br>65 2E 61 70 6B 20 2D 2D 6F 61 74 2D 66 64 3D 37<br>20 2D 2D 6F 61 74 2D 6C 6F 63 61 74 69 6F 6E 3D<br>2F 64 61 74 61 2F 64 61 6C 76 69 6B 2D 63 61 63<br>68 65 2F 61 72 6D 2F 64 61 74 61 40 61 70 70 40<br>63 6F 6D 2E 65 78 61 6D 70 6C 65 2E 70 61 73 73<br>65 72 62 79 2E 6D 79 61 70 70 6C 69 63 61 74 69<br>6F 6E 2E 61 70 70 2D 31 40 62 61 73 65 2E 61 70<br>6B 40 63 6C 61 73 73 65 73 2E 64 65 78 20 2D 2D<br>69 6E 73 74 72 75 63 74 69 6F 6E 2D 73 65 74 3D<br>61 72 6D 20 2D 2D 69 6E 73 74 72 75 63 74 69 6F<br>6E 2D 73 65 74 2D 66 65 61 74 75 72 65 73 3D 64<br>69 76 20 2D 2D 72 75 6E 74 69 6D 65 2D 61 72 67<br>20 2D 58 6D 73 36 34 6D 20 2D 2D 72 75 6E 74 69<br>6D 65 2D 61 72 67 20 2D 58 6D 78 35 31 32 6D 00<br>64 65 78 32 6F 61 74 2D 68 6F 73 74 00 41 72 6D<br>00 69 6D 61 67 65 2D 6C 6F 63 61 74 69 6F 6E 00<br>2F 64 61 74 61 2F 64 61 6C 76 69 6B 2D 63 61 63<br>68 65 2F 61 72 6D 2F 73 79 73 74 65 6D 40 66 72<br>61 6D 65 77 6F 72 6B 40 62 6F 6F 74 2E 61 72 74<br>00 78 70 6F 73 65 64 2D 6F 61 74 2D 76 65 72 73<br>69 6F 6E 00 32 00</p>
</blockquote>
<p>对应的字符信息：</p>
<p>dex2oat-cmdline\00<br>–zip-fd=6    –zip-location=/data/app/com.example.passerby.myapplication.app-1/base.apk –oat-fd=7     --oat-location=/data/dalvik-cache/arm/data@<a href="mailto:app@com.example.passerby.myapplication.app-1" target="_blank" rel="noopener">app@com.example.passerby.myapplication.app-1</a>@<a href="mailto:base.apk@classes.dex" target="_blank" rel="noopener">base.apk@classes.dex</a> –instruction-set=arm –instruction-set-features=div –runtime-arg -Xms64m –runtime-arg -Xmx512m\00<br>dex2oat-host\00<br>Arm\00<br>image-location\00<br>/data/dalvik-cache/arm/system@<a href="mailto:framework@boot.art" target="_blank" rel="noopener">framework@boot.art</a>\00<br>xposed-oat-version\00<br>2\    </p>
<p>OatHeader后就是Dex文件相关信息(开始位置:0x11FA):<br>根据OatHeader中dex_file_count_的值可知，此处共包含1个Dex文件的内容。<br>若用DexMetaData结构表示Dex文件的内容，其包含的字段如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">uint32_t dex_file_location_size;     //dex文件路径的字节数(4字节)    </span><br><span class="line">char* dex_file_location_data;        //dex文件的路径    </span><br><span class="line">uint32_t dex_file_checksum;          //dex文件的校验和(4字节)    </span><br><span class="line">uint32_t dex_file_offset;            //dex文件相对于oatdata段开始地址的偏移(4字节)   </span><br><span class="line">const uint32_t* methods_offsets_pointer;//是一个数组，元素共有class_defs_size（dex中类的数目）个，该数组的索引与dex中类的索引是一致的，</span><br><span class="line">                                        即第0个类对应methods_offsets_pointer[0],元素的值是相对于oatdata段开始地址的偏移，</span><br><span class="line">                                        比如dex中第0个类对应的OatClass在文件中的开始地址=methods_offsets_pointer[0]+oatdata段开始地址。</span><br></pre></td></tr></table></figure></p>
<p>所以，整个DexMetaData的字节数=OatHeader-&gt;dex_file_count_ <em> (4+dex_file_location_data+4+4+4</em>dex-&gt;class_defs_size)<br>                          = OatHeader-&gt;dex_file_count_ <em> (12+ dex_file_location_data + 4 </em> dex-&gt;class_defs_size)</p>
<p>案例分析⑤：data@<a href="mailto:app@com.example.passerby.myapplication.app-1" target="_blank" rel="noopener">app@com.example.passerby.myapplication.app-1</a>@<a href="mailto:base.apk@classes.dex" target="_blank" rel="noopener">base.apk@classes.dex</a></p>
<p>根据OatHeader的结束位置导出Dex文件信息(0x11FA)：   </p>
<blockquote>
<p>3B 00 00 00 2F 64<br>61 74 61 2F 61 70 70 2F 63 6F 6D 2E 65 78 61 6D<br>70 6C 65 2E 70 61 73 73 65 72 62 79 2E 6D 79 61<br>70 70 6C 69 63 61 74 69 6F 6E 2E 61 70 70 2D 31<br>2F 62 61 73 65 2E 61 70 6B 7C 2B D8 F3 7C 18 00<br>00 4C 23 22 00 58 23 22 00 6C 23 22 00 80 23 22<br>00 9C 23 22 00 A0 23 22 00 D4 23 22 00 D8 23 22<br>00 4C 24 22 00 50 24 22 00 6C 24 22 00 90 24 22<br>00 CC 24 22 00 E0 24 22 00 F4 24 22 00 40 25 22<br>00 44 25 22 00 48 25 22 00 6C 25 22 00 98 25 22<br>….</p>
</blockquote>
<p>dex文件路径的字节数：3B 00 00 00  //0x3B = 3*16+11个字节<br>dex文件路径：<br>2F 64 61 74 61 2F 61 70 70 2F 63 6F 6D 2E 65 78<br>61 6D 70 6C 65 2E 70 61 73 73 65 72 62 79 2E 6D<br>79 61 70 70 6C 69 63 61 74 69 6F 6E 2E 61 70 70<br>2D 31 2F 62 61 73 65 2E 61 70 6B    </p>
<p>对应的字符信息：    /data/app/com.example.passerby.myapplication.app-1/base.apk<br>dex文件校验和：7C 2B D8 F3<br>dex文件相对于oatdata段开始地址的偏移：7C 18 00 00   //0x187c  相对于oat文件的偏移：0x1000 + 0x187c = 0x287c   </p>
<p>methods_offsets_pointer:（每项4个字节，共class_defs_size项，即1422项，结束位置：0x1241+1422*4 = 0x2879）    </p>
<blockquote>
<p>4C 23 22 00 58 23 22 00 6C 23 22 00 80 23 22 00<br>9C 23 22 00 A0 23 22 00 D4 23 22 00 D8 23 22 00<br>4C 24 22 00 50 24 22 00 6C 24 22 00 90 24 22 00<br>CC 24 22 00 E0 24 22 00 F4 24 22 00 40 25 22 00<br>44 25 22 00 48 25 22 00 6C 25 22 00 98 25 22<br>…<br>00 C0 7D 23 00 C4 7E 23 00 00</p>
</blockquote>
<p>根据dex文件地址(0x287c-0x2A1000)导出数据：<br>64 65 78 0A 30 33 35 00 39 DD DD F3 29 80 26 28<br>9E D5 51 3F A1 2B 09 1A 7D D4 6F F8 80 20 96 4C<br>D0 0A 22 00 70 00 00 00 78 56 34 12 00 00 00 00<br>00 00 00 00 F4 09 22 00 19 53 00 00 70 00 00 00<br>87 08 00 00 D4 4C 01 00 51 0D 00 00 F0 6E 01 00<br>B0 3A 00 00 BC 0E 02 00 DF 3E 00 00 3C E4 03 00<br>8E 05 00 00 34 DB 05 00 DC 7D 1B 00 F4 8C 06 00<br>…</p>
<p>可以看到dex文件的文件头：<br>魔数：64 65 78 0A 30 33 35 00  //对应的字符信息dex.035<br>dex文件校验和：39 DD DD F3<br>dex文件sha1签名：29 80 26 28 9E D5 51 3F A1 2B 09 1A 7D D4 6F F8 80 20 96 4C<br>dex文件大小：D0 0A 22 00        //0x220AD0 推出文件结束地址： 0x287c + 0x220ad0 = 0x22334c<br>文件头大小：70 00 00 00         //0x70<br>字节序：78 56 34 12            //0x12345678 小端序<br>link_size_:00 00 00 00<br>link_off_:00 00 00 00<br>map_off_:F4 09 22 00<br>string_ids_size_:19 53 00 00<br>string_ids_off_:70 00 00 00<br>type_ids_size_:87 08 00 00<br>type_ids_off_:D4 4C 01 00<br>proto_ids_size_:51 0D 00 00<br>proto_ids_off_:F0 6E 01 00<br>field_ids_size_:B0 3A 00 00<br>fields_ids_off_:BC 0E 02 00<br>method_ids_size_:DF 3E 00 00<br>methods_ids_off_:3C E4 03 00<br>class_defs_size_:8E 05 00 00    //0x058E,1422,dex文件中共包含1422个类定义<br>class_defs_off_:34 DB 05 00     //0x05db34,相对于dex文件头的偏移位置，相对于oat文件的偏移：0x05db34+0x287c=0x0603b0<br>data_size_:DC 7D 1B 00<br>data_off_:F4 8C 06 00   </p>
<p>案例分析⑥：data@<a href="mailto:app@com.example.passerby.myapplication.app-1" target="_blank" rel="noopener">app@com.example.passerby.myapplication.app-1</a>@<a href="mailto:base.apk@classes.dex" target="_blank" rel="noopener">base.apk@classes.dex</a>   </p>
<p>使用dextra工具导出该oat文件中的dex或手动选中dex文件地址范围保存：（采用export的方式导出010的dex模板会识别不了，应该是导 出的格式有问题;下面所说的偏移都是相对于导出dex文件的偏移）<br>在010工具的type_ids中查找MainActivity，找到对应的索引号1925，转为16进制即：85 07 00 00 ，在010中全局搜索’85 07 00 00‘，找到MainActivity类定义偏移0x68cd4。<br>借助dex分析模板，找到mainActivity类定义的偏移位置：0x068cd4,由DexClassDef结构知，每个DexClassDef大小为32个字节    </p>
<blockquote>
<p>85 07 00 00 01 00 00 00 14 05 00 00 00 00 00 00<br>3E 16 00 00 00 00 00 00 5A 9C 20 00 00 00 00 00   </p>
</blockquote>
<p>类类型：85 07 00 00     //0x0785，指向type_ids的索引<br>访问标志：01 00 00 00   //0x1，public<br>父类类型：14 05 00 00   //0x0514，指向type_ids的索引<br>接口偏移：00 00 00 00   //0x0，指向type_ids的索引，class不为interface,此项值为0<br>源文件名：3E 16 00 00   //0x163e，指向string_ids的索引,string_ids[5094]，MainActivity.java<br>注解偏移：00 00 00 00   //0x0，指向DexAnnotationsDirectoryItem结构，若无此项内容，该值为0<br>类数据偏移：5A 9C 20 00 //0x209c5a，指向DexClassData结构的偏移<br>类静态数据偏移：00 00 00 00 //0x0，指向DexEncodedArray结构的偏移    </p>
<p>查看类数据：（0x209c5a）  </p>
<blockquote>
<p>00 02 01 02 8D 67 00 01 00 9B 79 81 80 04 8C E8<br>4B 9C 79 01 A4 E8 4B 02 04 80 E9 4B 03 04 00 04<br>01 04 02 02 04 02 04 01 02 1E 04 FF 01 37 6C 21<br>01 37 6D 21 04 04 05 04 03 04 02 04 04 0C 64 27<br>00 02 7F 64 7A 00 02 7F 64 7C 00 02 7F 64 7D 00<br>02 7F 64 7E 00 02 7F 64 7F 00 02 7F 64 80 00 02<br>7F 64 81 00 02 7F 64 82 00 02 7F 64 83 00 02 7F<br>64 84 00 02 7F 64<br>…<br>classDataHeader:<br>静态字段个数：0<br>实例字段个数：2<br>非虚方法：1<br>虚方法：2</p>
</blockquote>
<p>字段：…</p>
<p>非虚方法：…</p>
<p>虚方法：…</p>
<p>由该MainActivity类定义的偏移位置和class_defs_off偏移位置知：<br>(0x68cd4-0x5db34)/32=1421,即MainActivity是dex文件中第1422个类定义，在类定义列表中的下标为1421<br>对应methods_offsets_pointer[1421]</p>
<p>methods_offsets_pointer[1421]:C4 7E 23 00   //0X237EC4,该类对应的OatClass相对于oatdata的偏移<br>推出MainActivity对应的OatClass在文件中的偏移：0x237ec4+0x1000 = 0x238ec4   </p>
<p>MainActivity对应的OatClass:(一个direct方法，一个virtual方法)   </p>
<blockquote>
<p>08 00 00 00 B9 31 48 00 E0 7E 23 00 11 32 48 00<br>EF 5A 27 00 61 33 48 00 23 5B 27 00 09 00 03 00<br>28 01 3A 00 08 01 09 00 05 00 36 07 2C 07 48 00<br>08 06 24 06 09 00 06 00 62 00 34 06 08 06 24 06<br>3E 06 5A 06 09 00 03 00 5A 00 2C 07 08 07 09 00<br>0A 00 82 7A 9E 7A BC 00 C4 00 D6 00 CE 62 94 7A<br>72 6A 08 60 78 7A 00 00 00 00 09 00<br>…</p>
</blockquote>
<p>//TODO<br>status:08 00  //kStatusVerified<br>type:00 00    //kOatClassAllCompiled(没有bitmap结构)<br>OatMethodOffSets[0]:B9 31 48 00 E0 7E 23 00<br>OatMethodOffSets[1]:11 32 48 00 EF 5A 27 00<br>…</p>
<p>OatClass结构分析：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">//art/runtime/oat_file.h</span><br><span class="line">class OatClass &#123;</span><br><span class="line">    ...</span><br><span class="line">    private:</span><br><span class="line">    OatClass(</span><br><span class="line">        const OatFile* oat_file,</span><br><span class="line">        mirror::Class::Status status,</span><br><span class="line">        OatClassType type,</span><br><span class="line">        uint32_t bitmap_size,</span><br><span class="line">        const uint32_t* bitmap_pointer,</span><br><span class="line">        const OatMethodOffsets* methods_pointer</span><br><span class="line">    );</span><br><span class="line">    const OatFile*  oat_file_;</span><br><span class="line">    mirror::Class:Status status_;    //2 bytes</span><br><span class="line">    OatClassType type_;  //2 byes</span><br><span class="line">    const uint32_t* bitmap_;</span><br><span class="line">    const OatMethodOffsets* methods_pointer_;//方法的偏移数组，指向相应的native code，4bytes，OatMethodOffset的个数是该类被编译为native code的个数</span><br><span class="line">    friend class OatDexFile;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// art/runtime/mirror/class.h</span><br><span class="line"> enum Status &#123;</span><br><span class="line">    kStatusRetired = -2,</span><br><span class="line">    kStatusError = -1,</span><br><span class="line">    kStatusNotReady = 0,</span><br><span class="line">    kStatusIdx = 1,  // Loaded, DEX idx in super_class_type_idx_ and interfaces_type_idx_.</span><br><span class="line">    kStatusLoaded = 2,  // DEX idx values resolved.</span><br><span class="line">    kStatusResolving = 3,  // Just cloned from temporary class object.</span><br><span class="line">    kStatusResolved = 4,  // Part of linking.</span><br><span class="line">    kStatusVerifying = 5,  // In the process of being verified.</span><br><span class="line">    kStatusRetryVerificationAtRuntime = 6,  // Compile time verification failed, retry at runtime.</span><br><span class="line">    kStatusVerifyingAtRuntime = 7,  // Retrying verification at runtime.</span><br><span class="line">    kStatusVerified = 8,  // Logically part of linking; done pre-init.</span><br><span class="line">    kStatusInitializing = 9,  // Class init in progress.</span><br><span class="line">    kStatusInitialized = 10,  // Ready to go.</span><br><span class="line">    kStatusMax = 11,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// art/runtime/oat.h （OatClass类型不一样，methods_pointer_数组中的偏移位置的计算方式不一样）</span><br><span class="line">enum OatClassType &#123;</span><br><span class="line">  kOatClassAllCompiled = 0,   // OatClass is followed by an OatMethodOffsets for each method.</span><br><span class="line">  kOatClassSomeCompiled = 1,  // A bitmap of which OatMethodOffsets are present follows the OatClass.</span><br><span class="line">  kOatClassNoneCompiled = 2,  // All methods are interpretted so no OatMethodOffsets are necessary.</span><br><span class="line">  kOatClassMax = 3,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// art/runtime/oat.h</span><br><span class="line">class PACKED(4) OatMethodOffsets &#123;</span><br><span class="line"> public:</span><br><span class="line">  OatMethodOffsets();</span><br><span class="line"></span><br><span class="line">  OatMethodOffsets(uint32_t code_offset,</span><br><span class="line">                   uint32_t gc_map_offset);</span><br><span class="line"></span><br><span class="line">  ~OatMethodOffsets();</span><br><span class="line"></span><br><span class="line">  uint32_t code_offset_;//native code相对于oatdata段的偏移</span><br><span class="line">  uint32_t gc_map_offset_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>// OatMethodOffsets 计算方法<br>//函数参数method_idx是方法在dex表示的类中的偏移，比如类的第0个方法method_index为0，第一个方法为method_index为1，依次类推。<br>由于在OatClass中没有保存类中方法的数目，因而没有检查method_index的边界。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">const OatMethodOffsets* OatFile::OatClass::GetOatMethodOffsets(uint32_t method_index) const &#123;</span><br><span class="line">  // NOTE: We don&apos;t keep the number of methods and cannot do a bounds check for method_index.</span><br><span class="line">  if (methods_pointer_ == nullptr) &#123;//没有编译成native code</span><br><span class="line">    CHECK_EQ(kOatClassNoneCompiled, type_);</span><br><span class="line">    return nullptr;</span><br><span class="line">  &#125;</span><br><span class="line">  size_t methods_pointer_index;</span><br><span class="line">  if (bitmap_ == nullptr) &#123;//该类所有方法被编译成native code</span><br><span class="line">    CHECK_EQ(kOatClassAllCompiled, type_);</span><br><span class="line">    methods_pointer_index = method_index;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    CHECK_EQ(kOatClassSomeCompiled, type_);</span><br><span class="line">    if (!BitVector::IsBitSet(bitmap_, method_index)) &#123;//该方法没有对应的native code</span><br><span class="line">      return nullptr;</span><br><span class="line">    &#125;</span><br><span class="line">    size_t num_set_bits = BitVector::NumSetBits(bitmap_, method_index);//使用bitmap记录哪些方法被编译成了native code</span><br><span class="line">    methods_pointer_index = num_set_bits;//找到相应的索引</span><br><span class="line">  &#125;</span><br><span class="line">  const OatMethodOffsets&amp; oat_method_offsets = methods_pointer_[methods_pointer_index];</span><br><span class="line">  return &amp;oat_method_offsets;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//art/runtime/base/bit_vector.cc</span><br><span class="line">uint32_t BitVector::NumSetBits(const uint32_t* storage, uint32_t end) &#123;</span><br><span class="line">  uint32_t word_end = end &gt;&gt; 5; // end/32</span><br><span class="line">  uint32_t partial_word_bits = end &amp; 0x1f;// end%32</span><br><span class="line"></span><br><span class="line">  uint32_t count = 0u;// 为1的位的数目</span><br><span class="line">  for (uint32_t word = 0u; word &lt; word_end; word++) &#123;//先算前word_end个字中为1的位的数目，再算不满一个字的前partial_word_bits位中为1的位的数目</span><br><span class="line">    count += POPCOUNT(storage[word]);</span><br><span class="line">  &#125;</span><br><span class="line">  if (partial_word_bits != 0u) &#123;</span><br><span class="line">    count += POPCOUNT(storage[word_end] &amp; ~(0xffffffffu &lt;&lt; partial_word_bits));</span><br><span class="line">  &#125;</span><br><span class="line">  return count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Bitmap的作用：</p>
<ul>
<li>Bitmaps are used to represent which methods are compiled.</li>
<li>Each bit represents every method in the class ,starting with direct methods,then virtual methods.</li>
<li>If bit it is set,the method is compiled.</li>
</ul>
<p>从OatClass中获取指定方法的native code时，返回的是OatMethod对象，源码如下：<br>/art/runtime/oat_file.cc<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//method_index描述的是目标方法在类中的编号</span><br><span class="line">const OatFile::OatMethod OatFile::OatClass::GetOatMethod(uint32_t method_index) const &#123;</span><br><span class="line">  const OatMethodOffsets* oat_method_offsets = GetOatMethodOffsets(method_index);//获取方法偏移</span><br><span class="line">  if (oat_method_offsets == nullptr) &#123;</span><br><span class="line">    return OatMethod(nullptr, 0, 0);</span><br><span class="line">  &#125;</span><br><span class="line">  if (oat_file_-&gt;IsExecutable() ||</span><br><span class="line">      Runtime::Current() == nullptr ||        // This case applies for oatdump.</span><br><span class="line">      Runtime::Current()-&gt;IsCompiler()) &#123;</span><br><span class="line">    return OatMethod(</span><br><span class="line">        oat_file_-&gt;Begin(),</span><br><span class="line">        oat_method_offsets-&gt;code_offset_,</span><br><span class="line">        oat_method_offsets-&gt;gc_map_offset_);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    // We aren&apos;t allowed to use the compiled code. We just force it down the interpreted version.</span><br><span class="line">    return OatMethod(oat_file_-&gt;Begin(), 0, 0);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/art/runtime/oat_file.h</span><br><span class="line">class OatMethod&#123;</span><br><span class="line">    public:</span><br><span class="line">    ...</span><br><span class="line">    OatMethod(</span><br><span class="line">        const byte* base,</span><br><span class="line">        const uint32_t code_offset,</span><br><span class="line">        const uint32_t gc_map_offset</span><br><span class="line">    );</span><br><span class="line">    OatMethod()&#123;&#125;</span><br><span class="line">    private:</span><br><span class="line">    ...</span><br><span class="line">    const byte* begin_; //oatdata段开始位置</span><br><span class="line">    uint32_t code_offset_;  //OatMethodOffsets-&gt;code_offset_</span><br><span class="line">    uint32_t native_gc_map_offset_;</span><br><span class="line">    friend class OatClass;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>然后就可以通过OatMethod来定位到方法的native code了（begin_+code_offset_）。</p>
<p>总结：  </p>
<ul>
<li>Oat文件其实就是类型为shared object 的Elf文件，首先有一个Elf Header，Elf Header中e_phoff字段指向了program header talbe，e_shoff字段指向了section header table；</li>
<li>section header table中有一个名字为.dynsym的section head，该section head描述的section是符号表；</li>
<li>Oat文件导出了3个符号：oatdata，oatexec，oatlastword；</li>
<li>oatdata指向oatdata段，该区域存的是只读数据，包括 OatHeader，dex相关信息，dex类中方法与native code的映射关系（由 OatClass表示），通过OatClass可以找到对应方法的native code；</li>
<li>oatexec指向oatexec段，该区域存的是方法的native code，是可执行的；</li>
<li>oatlastword指向oatexec段的最后一个字的开始地址。即oatexec段的结束地址=oatlastword-&gt;st_value+3。</li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android-Oat/" rel="tag"># Android Oat</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/12/23/hello-world/" rel="next" title="Hello World">
                <i class="fa fa-chevron-left"></i> Hello World
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/12/26/Java-打印堆栈信息/" rel="prev" title="Java 打印堆栈信息">
                Java 打印堆栈信息 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Heinz">
            
              <p class="site-author-name" itemprop="name">Heinz</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">30</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">35</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/itmayi" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:799902881@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#elf文件结构-32位-："><span class="nav-number">1.</span> <span class="nav-text">elf文件结构(32位)：</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Heinz</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>



        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("jypPJXy89LBDsg88boqicDg9-gzGzoHsz", "7z1xPLru7WIRw9p0A6SE779N");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
