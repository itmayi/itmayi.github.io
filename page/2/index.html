<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="榆木的博客">
<meta name="keywords" content="随笔">
<meta property="og:type" content="website">
<meta property="og:title" content="Heinz Blog">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Heinz Blog">
<meta property="og:description" content="榆木的博客">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Heinz Blog">
<meta name="twitter:description" content="榆木的博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/">





  <title>Heinz Blog - 记录每一段岁月的美好！</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Heinz Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">记录每一段岁月的美好！</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/28/Android-逐步认识ART系列二/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Heinz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Heinz Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/28/Android-逐步认识ART系列二/" itemprop="url">Android 逐步认识ART系列二</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-28T11:33:34+08:00">
                2018-12-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/12/28/Android-逐步认识ART系列二/" class="leancloud_visitors" data-flag-title="Android 逐步认识ART系列二">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="boot-oat"><a href="#boot-oat" class="headerlink" title="boot.oat"></a>boot.oat</h1><ul>
<li>Contains libs and frameworks in boot class path<br>  – To be pre-loaded in all apps（系统启动路径下的的需要预加载库和框架）</li>
</ul>
<p>任何应用程序都不是孤立存在的，几乎所有应用程序都会依赖Android Framework中提供的基础类，例如Activity，Intent，Parcel等类。所以在应用程序的代码中，自然少不了对于这些类的引用.</p>
<p>考虑到几乎所有应用都存在这种引用关系，在运行时都会依赖于Framework中的类，因此系统如何处理这部分逻辑就是非常重要的了，因为这个处理的方法将影响到所有应用程序。</p>
<p>在AOSP编译时，会将所有这些公共类放到专门的一个Oat文件中，这个文件就是：boot.oat。与之配合的还有一个boot.art文件。</p>
<p>boot.oat可以在两个地方找到：</p>
<ol>
<li><p>/system/framework/[platform]/boot.oat</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@hammerhead:/system/framework/arm # ls -l</span><br><span class="line">-rw-r--r-- root     root     50767704 2014-11-20 19:07 boot.oat</span><br></pre></td></tr></table></figure>
</li>
<li><p>/data/dalvik-cache/[platform]/system@<a href="mailto:framework@boot.oat" target="_blank" rel="noopener">framework@boot.oat</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@hammerhead:/data/dalvik-cache/arm # ls -l</span><br><span class="line">-rw-r--r-- root     root     51003824 1970-05-29 01:45 system@framework@boot.oat</span><br></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/system/bin/dex2oat --image=/data/dalvik-cache/system@framework@boot.art --runtime-arg</span><br><span class="line">-Xms64m --runtime-arg -Xmx64m --dex-file=/system/framework/core-libart.jar --dex-file=/</span><br><span class="line">system/framework/conscrypt.jar --dex-file=/system/framework/okhttp.jar --dex-file=/</span><br><span class="line">system/framework/core-junit.jar --dex-file=/system/framework/bouncycastle.jar --dexfile=/system/framework/ext.jar --dex-file=/system/framework/framework.jar --dex-file=/</span><br><span class="line">system/framework/framework2.jar --dex-file=/system/framework/telephony-common.jar --</span><br><span class="line">dex-file=/system/framework/voip-common.jar --dex-file=/system/framework/mms-common.jar</span><br><span class="line">--dex-file=/system/framework/android.policy.jar --dex-file=/system/framework/</span><br><span class="line">services.jar --dex-file=/system/framework/apache-xml.jar --dex-file=/system/framework/</span><br><span class="line">webviewchromium.jar --oat-file=/data/dalvik-cache/system@framework@boot.oat --runtimearg -implicit-checks:none --instruction-set=arm --instruction-set-features=default --</span><br><span class="line">base=0x70000000 --image-classes-zip=/system/framework/framework.jar</span><br></pre></td></tr></table></figure>
<p><strong>上面命令编译进boot.oat中的jar:</strong><br>/system/framework/core-libart.jar<br>/system/framework/conscrypt.jar<br>/system/framework/okhQp.jar<br>/system/framework/core-junit.jar<br>/system/framework/bouncycastle.jar<br>/system/framework/ext.jar<br>/system/framework/framework.jar<br>/system/framework/framework2.jar<br>/system/framework/telephony-common.jar<br>/system/framework/voip-common.jar<br>/system/framework/mms-common.jar<br>/system/framework/android.policy.jar<br>/system/framework/services.jar<br>/system/framework/apache-xml.jar<br>/system/framework/webviewchromium.jar  </p>
<h1 id="boot-art-boot-image"><a href="#boot-art-boot-image" class="headerlink" title="boot.art(boot image)"></a>boot.art(boot image)</h1><ul>
<li>contains absolute pointers for methods in boot.oat(以绝对地址指向boot.oat中的方法)</li>
<li>boot.art和boot.oat的加载地址都是32位，在64位的系统上，高32位都是0</li>
</ul>
<p>boot.art中包含了指向boot.oat中方法代码的指针，它被称之为启动镜像（Boot Image），并且被加载的位置是固定的。boot.oat被加载的地址紧随着boot.art。</p>
<p>boot.art可以在两个地方找到：</p>
<ol>
<li><p>/system/framework/[platform]/boot.art</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@hammerhead:/system/framework/arm # ls -l</span><br><span class="line">-rw-r--r-- root     root     11829248 2014-11-20 19:07 boot.art</span><br></pre></td></tr></table></figure>
</li>
<li><p>/data/dalvik-cache/[platform]/system@<a href="mailto:framework@boot.art" target="_blank" rel="noopener">framework@boot.art</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@hammerhead:/data/dalvik-cache/arm # ls -l</span><br><span class="line">-rw-r--r-- root     root     11829248 1970-05-29 01:45 system@framework@boot.art</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="Profiling"><a href="#Profiling" class="headerlink" title="Profiling"></a>Profiling</h1><ul>
<li>By default,ART compiles methods regardless of impact on performance(ART编译方法时，不会考虑对性能的影响)</li>
<li>Profiling feature allows ART to be more selective on which methods to compile(profile能够控制dex2oat具体要对哪些方法进行编译优化)</li>
<li>Profiling配置默认可能是关闭的。可以通过setprop手动打开</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setprop dalvik.vm.profiler 1</span><br></pre></td></tr></table></figure>
<p>- No AOT compilation upon app install(在App安装时不会进行AOT优化，一方面时为了减少安装时间、另一方面时节省存储空间)</p>
<ul>
<li>Profiling data is collected while app is runing(在App运行期间，会收集profile数据)</li>
<li>Profile files are placed in /data/dalvik-cache/profiles</li>
<li>Profile file name is the package name</li>
<li>Profile data is used to determine if AOT compilation will be done</li>
</ul>
<p>example:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">42/2/352  </span><br><span class="line">android.database.Cursor com.android.email.provider.EmailProvider.uiAccounts(java.lang.String[])/1/128  </span><br><span class="line">void com.android.email.NotificationController.ensureHandlerExists()/1/37</span><br><span class="line">int com.android.email.provider.EmailProvider.getFolderTypeFromMailboxType(int)/2/56</span><br><span class="line">boolean com.android.mail.browse.ConversationCursor$ConversationProvider.onCreate()/1/49</span><br><span class="line">com.google.common.collect.ImmutableList com.google.common.collect.ImmutableList.of()/1/3</span><br><span class="line">&lt;snip&gt;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>First line is the summary inforamtion<blockquote>
<p>count/Null methods count/Boot path methods count</p>
</blockquote>
</li>
<li>Subsequent lines are the profile data<blockquote>
<p>Methods name/Count/Size</p>
</blockquote>
</li>
</ul>
<h1 id="App-Image"><a href="#App-Image" class="headerlink" title="App Image"></a>App Image</h1><ul>
<li>/data/app/xxx/oat/arm/base.art</li>
<li>/data/app/xxx/oat/rm/base.odex</li>
</ul>
<p>base.art 就是对应的App image文件。主要记录已经编译好的类的具体信息以及函数在oat文件的位置，相当于缓存，在app运行的时候会加载到虚拟机，可以加快启动速度。</p>
<p><strong>在Android7.0上，dex2oat的参数 compiler-filter被指定为profile类型的几个compiler-filter之一时，dex2oat还会生成app-image文件。</strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/27/Android-逐步认识ART系列一/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Heinz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Heinz Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/27/Android-逐步认识ART系列一/" itemprop="url">Android 逐步认识ART系列一</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-27T22:52:11+08:00">
                2018-12-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/12/27/Android-逐步认识ART系列一/" class="leancloud_visitors" data-flag-title="Android 逐步认识ART系列一">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>参考资料：<br>原文：<a href="https://blog.csdn.net/hl09083253cy/article/details/78418809" target="_blank" rel="noopener">https://blog.csdn.net/hl09083253cy/article/details/78418809</a><br>原文：<a href="https://paul.pub/android-art-vm/#id-art-vs-dalvik" target="_blank" rel="noopener">https://paul.pub/android-art-vm/#id-art-vs-dalvik</a><br>Android Source：<a href="https://source.android.com.devices/tech/dalvik/configure" target="_blank" rel="noopener">https://source.android.com.devices/tech/dalvik/configure</a>  </p>
<h1 id="JIT"><a href="#JIT" class="headerlink" title="JIT"></a>JIT</h1><p>我们知道，C/C++的效率要比 Java好，因为C/C++会被直接编译成汇编指令，CPU可以直接读取运行；而Java却是需要虚拟机一步一步的解释每一条 java bytecode。</p>
<p>而Dalvik 中使用了一个技术，叫做JIT，会在解释执行一个java方法或者一个java代码段时，进行trace，并在不断的执行过程中找到 hotspot，</p>
<p>然后将相应的方法或者代码片段编译为对应的汇编指令，下次再执行到该方法时，会直接执行其对应的汇编指令，依次来提升部分效率。</p>
<p>可以理解为：运行时追踪，并对hotspot进行编译生成高效的可执行指令。</p>
<p>JIT的运行流程</p>
<ol>
<li>用户运行应用，而这随后就会触发 ART 加载 .dex 文件。<ol>
<li>如果有 .oat 文件（即 .dex 文件的 AOT 二进制文件），则 ART 会直接使用该文件。虽然 .oat 文件会定期生成，但文件中不一定会包含经过编译的代码（即 AOT 二进制文件）。</li>
<li>如果没有 .oat 文件，则 ART 会通过 JIT 或解释器执行 .dex 文件。如果有 .oat 文件，ART 将一律使用这类文件。否则，它将在内存中使用并解压 APK 文件，从而得到 .dex 文件，但是这会导致消耗大量内存（相当于 dex 文件的大小）。</li>
</ol>
</li>
<li>针对任何未根据speed编译过滤器编译（见下文）的应用启用JIT（也就是说，要尽可能多地编译应用中的代码）。</li>
<li>将 JIT 配置文件数据转存到只限应用访问的系统目录内的文件中。</li>
<li>AOT 编译 dex2oat 守护进程通过解析该文件来推进其编译。</li>
</ol>
<p>要开启 JIT 日志记录，请运行以下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">adb root</span><br><span class="line">adb shell stop</span><br><span class="line">adb shell setprop dalvik.vm.extra-opts -verbose:jit</span><br><span class="line">adb shell start</span><br></pre></td></tr></table></figure>
<p>要停用 JIT，请运行以下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">adb root</span><br><span class="line">adb shell stop</span><br><span class="line">adb shell setprop dalvik.vm.usejit false</span><br><span class="line">adb shell start</span><br></pre></td></tr></table></figure>
<h1 id="AOT"><a href="#AOT" class="headerlink" title="AOT"></a>AOT</h1><p>Ahead-of-time（AOT）是相对于Just-in-time（JIT）而言的。JIT是在运行时进行字节码到本地机器码的编译，这也是为什么Java普遍被认为效率比C++差的原因。无论是解释器的解释还是运行过程中即时编译，都比C++编译出的本地机器码执行多了一个耗费时间的过程。而AOT就是向C++编译过程靠拢的一项技术：当APK在安装的时候，系统会通过一个名称为dex2oat的工具将APK中的dex文件编译成包含本地机器码的oat文件存放下来。这样做之后，在程序执行的时候，就可以直接使用已经编译好的机器码以加快效率。</p>
<h1 id="单纯的JIT存在的问题"><a href="#单纯的JIT存在的问题" class="headerlink" title="单纯的JIT存在的问题"></a>单纯的JIT存在的问题</h1><ol>
<li>执行效率差</li>
</ol>
<h1 id="单纯的AOT存在的问题"><a href="#单纯的AOT存在的问题" class="headerlink" title="单纯的AOT存在的问题"></a>单纯的AOT存在的问题</h1><ol>
<li>应用安装时间长</li>
<li>系统更新后，要重新编译所有应用</li>
<li>浪费存储空间（为所有方法执行编译）</li>
</ol>
<h1 id="AOT-JIT"><a href="#AOT-JIT" class="headerlink" title="AOT+JIT"></a>AOT+JIT</h1><p>从Android 7.0（代号Nougat,简称N）开始，ART组合使用了AOT、JIT和配置文件引导型编译。所有这些编译模式的组合均可配置。例如，在Pixel设备上，相应的配置如下：</p>
<ol>
<li>最初在安装应用程序的时候不执行任何AOT编译。应用程序运行的前几次都将使用解释模式，<strong>并且经常执行的方法将被JIT编译</strong>。</li>
<li><strong>当设备处于空闲状态并正在充电时</strong>，编译守护进程会根据第一次运行期间生成的Profile文件对<strong>常用代码</strong>运行AOT编译。</li>
<li>应用程序的<strong>下一次重新启动将使用Profile文件引导的代码</strong>，并<strong>避免在运行时为已编译的方法进行JIT编译</strong>。在<strong>新运行期间得到JIT编译的方法将被添加到Profile文件中</strong>，然后被编译守护进程使用。</li>
</ol>
<p>ART包含一个编译器（dex2oat工具）和一个为启动zygote而加载的运行时（libart.so）。在应用程序安装时，APK文件会传递给dex2oat工具，该工具会为根据APK文件生成一个或多个编译产物，这些产物文件名和扩展名可能会在不同版本之间发生变化，但从Android 8.0版本开始，生成的文件是：</p>
<ul>
<li>.vdex：包含APK的未压缩Dex代码，以及一些额外的元数据用来加速验证。</li>
<li>.odex：包含APK中方法的AOT编译代码。（注意，虽然Dalvik虚拟机时代也会生成odex文件，但和这里的odex文件仅仅是后缀一样，文件内容已经完全不同了）</li>
<li>.art（可选）：包含APK中列出的一些字符串和类的ART内部表示，用于加速应用程序的启动    </li>
</ul>
<h1 id="编译选项"><a href="#编译选项" class="headerlink" title="编译选项"></a>编译选项</h1><p>ART的编译选项分为以下两个类别：</p>
<ol>
<li>系统ROM配置：编译系统映像时，会对哪些代码进行AOT编译。</li>
<li>运行时配置：ART如何在设备上编译和运行应用。</li>
</ol>
<p>用于配置这两个类别的一个核心ART选项就是”编译过滤器“，编译过滤器可控制ART如何编译DEX代码，是一个传递给dex2oat工具的选项。从Android 8.0开始，有四个官方支持的过滤器：</p>
<ol>
<li>verify：只运行DEX代码验证</li>
<li>quicken：运行DEX代码验证，并优化一些DEX指令，以获得更好的解释器性能。</li>
<li>speed：运行DEX代码验证，并对所有方法进行AOT编译。</li>
<li><p>speed-profile：运行DEX代码验证，并对配置文件中列出的方法进行AOT编译</p>
<h2 id="系统ROM配置"><a href="#系统ROM配置" class="headerlink" title="系统ROM配置"></a>系统ROM配置</h2><p>有一些编译选项可用于配置系统ROM，如何配置这些选项取决于/system的可用存储空间以及预先安装的应用数量。编译到系统AROM中的JAR/APK可以分为以下四个类别：</p>
<ol>
<li>启动类路径代码：默认使用speed编译过滤器进行编译 </li>
<li>系统服务代码：默认使用speed编译过滤器进行编译</li>
<li>产品专属的核心应用：默认使用speed编译过滤器进行编译</li>
<li>所有其他应用：默认使用quicken编译过滤器进行编译</li>
</ol>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/26/dex2oat源码分析/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Heinz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Heinz Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/26/dex2oat源码分析/" itemprop="url">Android-逐步认识ART系列三</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-26T17:52:49+08:00">
                2018-12-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/12/26/dex2oat源码分析/" class="leancloud_visitors" data-flag-title="Android-逐步认识ART系列三">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>dex2oat是将dex文件编译成Oat文件的工具，位于/system/bin/dex2oat</p>
<p>dex2oat生成的oat文件位于设备上/data/dalvik-cache/目录下,同时，由于32位和64位的机器码有所区别，因此这个目录下还会通过子文件夹对oat文件进行分类。例如，手机上通常会有下面两个目录：  </p>
<ul>
<li>/data/dalvik-cache/arm/  </li>
<li>/data/dalvik-cache/arm64/</li>
</ul>
<h1 id="dex2oat："><a href="#dex2oat：" class="headerlink" title="dex2oat："></a>dex2oat：</h1><ul>
<li>Retrieve classes.dex from APK (从apk中检索classes.dex)</li>
<li>verify each class（验证每个类）</li>
<li>verify each method（验证每个方法）</li>
<li>verify each dalvik instruction（验证每条dalvik指令）</li>
</ul>
<h1 id="dex2oat编译过程"><a href="#dex2oat编译过程" class="headerlink" title="dex2oat编译过程"></a>dex2oat编译过程</h1><p>依次编译输入参数中的所有dex文件;  每个dex文件又按照单个class进行编译; 对于每个class，依次编译其除abstract函数、\<cinit>之外的所有函数，包括 native（jni）/static/及一般函数，进行生成native code，并存放在compiler中。</cinit></p>
<p>当编译完成后，会从compiler中把native code， dex文件，以及必要的组织信息，写入到OAT文件中；如果指定了生成app-image，还会再生成一份 app-image文件。</p>
<h1 id="dex2oat的触发时机"><a href="#dex2oat的触发时机" class="headerlink" title="dex2oat的触发时机"></a>dex2oat的触发时机</h1><p>dex2oat进程的启动，可以分为两大类：一类是 installd进程触发的dex2oat；另一类是由 app中直接调用的dex2oat。</p>
<h2 id="installd中触发dex2oat有以下几个场景："><a href="#installd中触发dex2oat有以下几个场景：" class="headerlink" title="installd中触发dex2oat有以下几个场景："></a>installd中触发dex2oat有以下几个场景：</h2><pre><code>1. 应用安装，包括普通安装和通过shellCmd安装），安装一个app时，安装过程中需要编译dex文件，会通知installd来触发一个dex2oat进程。
2. 开机扫描，开机过程中，PMS扫描已安装app过程，判断需要优化时，则会对install发出通知。
3. BackgroundDexOptService，（空闲时段或者开机之后触发的Backgroud的 Job），会通知installd进行dex2oat
4. OTADexoptService，好象是OAT过程中的触发的，这个场景没有进行过实际的验证
</code></pre><h2 id="app中调用dex2oat"><a href="#app中调用dex2oat" class="headerlink" title="app中调用dex2oat"></a>app中调用dex2oat</h2><p>一般是App的进程fork出一个子进程，子进程用来执行dex2oat，编译相关的dex，而父进程进行 waitpid 等待，等待完成后再运行其他逻辑。<br>例如：  </p>
<ol>
<li>微信安装后的首次启动，是有dex2oat的调用</li>
<li>淘宝安装后的首次搜索，也有dex2oat的调用</li>
</ol>
<p>这个也是其首次启动或者搜索的一个耗时点。</p>
<p> 由系统触发的dex2oat，都是通过通知installd来进行编译业务。</p>
<p> 由应用触发的dex2oat，一般都是自行构建参数，直接调用dex2oat。</p>
<h1 id="compiler-backend-类型"><a href="#compiler-backend-类型" class="headerlink" title="compiler-backend 类型"></a>compiler-backend 类型</h1><ul>
<li>Portable</li>
<li>Quick</li>
<li><p>Optimizing</p>
<h2 id="Quick-Backend"><a href="#Quick-Backend" class="headerlink" title="Quick Backend"></a>Quick Backend</h2><blockquote>
<p>MIR -&gt; LIR -&gt; Native Code</p>
</blockquote>
<ul>
<li>Medium level IR(DEX ByteCode)</li>
<li>Low level IR</li>
<li>Native Code</li>
<li>some optimizations at each stage</li>
</ul>
<h2 id="Optimizing-Backend"><a href="#Optimizing-Backend" class="headerlink" title="Optimizing Backend"></a>Optimizing Backend</h2><ul>
<li>Basically Quick with additional optimizations</li>
</ul>
<h2 id="Portable-Backend"><a href="#Portable-Backend" class="headerlink" title="Portable Backend"></a>Portable Backend</h2><blockquote>
<p>MIR -&gt; LLVM Bitcode -&gt; LLVM optimizer -&gt; LLVM Backend -&gt; native code</p>
</blockquote>
<ul>
<li>Uses LLVM Bitcode as its LIR</li>
<li>Optimizations using LLVM optimizer</li>
<li>Code generation is done by LLVM backends</li>
</ul>
</li>
</ul>
<h1 id="编译优化条件和对象（没太搞明白的地方）"><a href="#编译优化条件和对象（没太搞明白的地方）" class="headerlink" title="编译优化条件和对象（没太搞明白的地方）"></a>编译优化条件和对象（没太搞明白的地方）</h1><h2 id="什么情况下App需要使用dex2oat进行编译优化"><a href="#什么情况下App需要使用dex2oat进行编译优化" class="headerlink" title="什么情况下App需要使用dex2oat进行编译优化?"></a>什么情况下App需要使用dex2oat进行编译优化?</h2><ul>
<li><p>Number of methods comprising 90% of called methods has changed by &gt; 10%.(被调用方法的比例若大于10%，则会触发dex2oat编译优化)</p>
<h2 id="若要使用dex2oat-哪些方法会被dex2oat考虑进去？"><a href="#若要使用dex2oat-哪些方法会被dex2oat考虑进去？" class="headerlink" title="若要使用dex2oat,哪些方法会被dex2oat考虑进去？"></a>若要使用dex2oat,哪些方法会被dex2oat考虑进去？</h2></li>
<li>Methods comprising 90% of called methods.()</li>
</ul>
<h1 id="dex2oat命令行参数"><a href="#dex2oat命令行参数" class="headerlink" title="dex2oat命令行参数"></a>dex2oat命令行参数</h1><p>example:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/system/bin/dex2oat --zip-fd=6 --zip-location=/system/app/</span><br><span class="line">Email.apk --oat-fd=7 --oat-location=/data/dalvik-cache/</span><br><span class="line">system@app@Email.apk@classes.dex --profile-file=/data/</span><br><span class="line">dalvik-cache/profiles/com.android.email</span><br></pre></td></tr></table></figure></p>
<p>参数说明：<br>–zip-fd=\<file-descriptor>:包含classes.dex文件的zip文件描述符。<br>–oat-fd=\<number>:通过此文件描述符指定输出的oat文件的路径。<br>–oat-location=\<oat-name>:指定一个与–oat-fd指定的文件描述符相对应的象征性名字。<br>–profile-file：引导dex2oat编译优化的配置文件。文件位置：/data/dalvik-cache/profiles/应用包名</oat-name></number></file-descriptor></p>
<p>其他重要参数说明(参考android7.0.0源码)：<br>-j\<number>:指定进行编译优化时要用到的线程总数。默认根据硬件适配，例如：-j12<br>–dex-file=\<dex-file>:指定要编译的文件，后缀可以是.dex、.jar、.apk，例如：–dex-file=/system/framework/core.jar<br>–dex-location=\<dex-location>:dex文件路径,与–dex-file相对应，例如：–dex-file=/home/build//out/system/framework/core.jar;–dex-location=/system/framework/core.jar。<br>–zip-location=\<zip-location>:zip文件路径。例如：–zip-location=/system/app/Calculator.apk<br>–oat-file=\&lt;file.oat&gt;:输出的oat文件名。例如：–oat-file=/system/framework/boot.oat。<br>–oat-symbols=\&lt;file.oat&gt;:指定输出完整符号的oat路径。例如：–oat-symbols=/symbols/system/framework/boo.art。<br>–instruction-set=(arm|arm64|mips|mips64|x86|x86_64):指定指令集架构类型，默认为arm。<br>–compile-backend=(Quick|Optimizing):指定编译器后端。默认为Optimizing。<br>–compiler-filter=(verify-none|verify-at-runtime|verify-profile|interpret-only|time|space-profile|space|balanced|speed-profile|speed|everything-profile|everything):指定编译器过滤模式，默认为speed。</zip-location></dex-location></dex-file></number></p>
<h1 id="dex2oat主要流程"><a href="#dex2oat主要流程" class="headerlink" title="dex2oat主要流程"></a>dex2oat主要流程</h1><p>main函数入口：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">int main(int argc, char** argv) &#123;</span><br><span class="line">  int result = art::dex2oat(argc, argv);</span><br><span class="line">  // Everything was done, do an explicit exit here to avoid running Runtime destructors that take</span><br><span class="line">  // time (bug 10645725) unless we&apos;re a debug build or running on valgrind. Note: The Dex2Oat class</span><br><span class="line">  // should not destruct the runtime in this case.</span><br><span class="line">  if (!art::kIsDebugBuild &amp;&amp; (RUNNING_ON_MEMORY_TOOL == 0)) &#123;</span><br><span class="line">    exit(result);</span><br><span class="line">  &#125;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>dex2oat函数入口：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">static int dex2oat(int argc, char** argv) &#123;</span><br><span class="line">  b13564922();</span><br><span class="line">    </span><br><span class="line">  TimingLogger timings(&quot;compiler&quot;, false, false);</span><br><span class="line"></span><br><span class="line">  // Allocate `dex2oat` on the heap instead of on the stack, as Clang</span><br><span class="line">  // might produce a stack frame too large for this function or for</span><br><span class="line">  // functions inlining it (such as main), that would not fit the</span><br><span class="line">  // requirements of the `-Wframe-larger-than` option.</span><br><span class="line">  std::unique_ptr&lt;Dex2Oat&gt; dex2oat = MakeUnique&lt;Dex2Oat&gt;(&amp;timings);</span><br><span class="line"></span><br><span class="line">  // Parse arguments. Argument mistakes will lead to exit(EXIT_FAILURE) in UsageError.</span><br><span class="line">  dex2oat-&gt;ParseArgs(argc, argv);</span><br><span class="line"></span><br><span class="line">  // If needed, process profile information for profile guided compilation.</span><br><span class="line">  // This operation involves I/O.</span><br><span class="line">  if (dex2oat-&gt;UseProfileGuidedCompilation()) &#123;</span><br><span class="line">    if (!dex2oat-&gt;LoadProfile()) &#123;</span><br><span class="line">      LOG(ERROR) &lt;&lt; &quot;Failed to process profile file&quot;;</span><br><span class="line">      return EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Check early that the result of compilation can be written</span><br><span class="line">  if (!dex2oat-&gt;OpenFile()) &#123;</span><br><span class="line">    return EXIT_FAILURE;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Print the complete line when any of the following is true:</span><br><span class="line">  //   1) Debug build</span><br><span class="line">  //   2) Compiling an image</span><br><span class="line">  //   3) Compiling with --host</span><br><span class="line">  //   4) Compiling on the host (not a target build)</span><br><span class="line">  // Otherwise, print a stripped command line.</span><br><span class="line">  if (kIsDebugBuild || dex2oat-&gt;IsBootImage() || dex2oat-&gt;IsHost() || !kIsTargetBuild) &#123;</span><br><span class="line">    LOG(INFO) &lt;&lt; CommandLine();</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    LOG(INFO) &lt;&lt; StrippedCommandLine();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (!dex2oat-&gt;Setup()) &#123;</span><br><span class="line">    dex2oat-&gt;EraseOatFiles();</span><br><span class="line">    return EXIT_FAILURE;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  bool result;</span><br><span class="line">  if (dex2oat-&gt;IsImage()) &#123;//App Image 或者Boot Image</span><br><span class="line">    result = CompileImage(*dex2oat);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    result = CompileApp(*dex2oat);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  dex2oat-&gt;Shutdown();</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>当使用profile-guide 编译app时，会先 LoadProfile(),进行解析出 class index 和 method index，放到 ProfileCompilationinfo 中;<br>如果当前的编译要生成 image时，走CompileImage流程，否则走CompileApp流程;</p>
</blockquote>
<p>不论是编译image还是App都会包含以下一个工作：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dex2oat.Compile();//核心</span><br><span class="line"></span><br><span class="line">dex2oat.WriteOatFiles();//嵌入ELF</span><br><span class="line"></span><br><span class="line">dex2oat.FlushCloseOatFiles();</span><br><span class="line"></span><br><span class="line"> dex2oat.DumpTiming()</span><br></pre></td></tr></table></figure></p>
<p>CompileApp和CompileImage的区别是：</p>
<ol>
<li>编译image时需要 LoadClassProfileDescriptors() 产生 image_classes_ 集合，和生成 image（HandleImage()）;</li>
<li>在生成的app image中将会包含 image_classes_ 集合中类的对象，不在 image_classes_集合中的app的类的对象，将不会被生成到 app-image中。</li>
<li>LoadClassProfileDescriptors（）在从 profile信息中获取 image_classes_集合时，将会把 app dex 中的类以外的类，都过滤掉，比如 classpath dex 对应的类将不会生成到 app-image;</li>
</ol>
<p>dex2oat工作流程总结：</p>
<ol>
<li>根据dex2oat接收到的参数，组织编译参数</li>
<li>如果是 profile-guide 编译，则先进行 load app对应的 profile</li>
<li>收集参数中包含的所有dex file，启动 Compiler 编译这些dex file（classpath中对应的dex file，即uses-library 引用的jar文件，不会被编译），编译生成的数据放在compiler-driver中</li>
<li>使用 compiler-driver 中的数据，依据 oat文件设计的格式，组织成oat文件，嵌入到 ELF文件中</li>
<li>如果指定需要生成 app-image，则使用 HandleImage()， 生成app-image， 即 ***.art 文件</li>
</ol>
<h2 id="编译流程"><a href="#编译流程" class="headerlink" title="编译流程"></a>编译流程</h2>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/26/Android-部分系统版本变更行为/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Heinz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Heinz Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/26/Android-部分系统版本变更行为/" itemprop="url">Android 部分系统版本变更行为</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-26T17:34:14+08:00">
                2018-12-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/12/26/Android-部分系统版本变更行为/" class="leancloud_visitors" data-flag-title="Android 部分系统版本变更行为">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>主要关注安全方面</strong></p>
<h1 id="Android-6-0部分变更行为："><a href="#Android-6-0部分变更行为：" class="headerlink" title="Android 6.0部分变更行为："></a>Android 6.0部分变更行为：</h1><ul>
<li>运行时权限</li>
</ul>
<p>此版本引入了一种新的权限模式，如今，用户可直接在运行时管理应用权限。这种模式让用户能够更好地了解和控制权限，同时为应用开发者精简了安装和自动更新过程。用户可为所安装的各个应用分别授予或撤销权限。</p>
<ul>
<li>低电耗模式和应用待机模式</li>
</ul>
<p>此版本引入了针对空闲设备和应用的最新节能优化技术。</p>
<ul>
<li>低电耗模式：如果用户拔下设备的电源插头，并在屏幕关闭后的一段时间内使其保持不活动状态，设备会进入低电耗模式，在该模式下设备会尝试让系统保持休眠状态。在该模式下，设备会定期短时间恢复正常工作，以便进行应用同步，还可让系统执行任何挂起的操作。</li>
<li>应用待机模式：应用待机模式允许系统判定应用在用户未主动使用它时处于空闲状态。当用户有一段时间未触摸应用时，系统便会作出此判定。如果拔下了设备电源插头，系统会为其视为空闲的应用停用网络访问以及暂停同步和作业。</li>
</ul>
<ul>
<li>取消支持 Apache HTTP 客户端</li>
</ul>
<p>Android 6.0 版移除了对 Apache HTTP 客户端的支持。如果您的应用使用该客户端，并以 Android 2.3（API 级别 9）或更高版本为目标平台，请改用 HttpURLConnection 类。此 API 效率更高，因为它可以通过透明压缩和响应缓存减少网络使用，并可最大限度降低耗电量。要继续使用 Apache HTTP API，您必须先在 build.gradle 文件中声明以下编译时依赖项：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    useLibrary &apos;org.apache.http.legacy&apos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>Boring SSL</li>
</ul>
<p>Android 正在从使用 OpenSSL 库转向使用 BoringSSL 库。如果您要在应用中使用 Android NDK，请勿链接到并非 NDK API 组成部分的加密库，如 libcrypto.so 和 libssl.so。这些库并非公共 API，可能会在不同版本和设备上毫无征兆地发生变化或出现故障。此外，您还可能让自己暴露在安全漏洞的风险之下。请改为修改原生代码，以通过 JNI 调用 Java 加密 API，或静态链接到您选择的加密库。</p>
<ul>
<li>运行时</li>
</ul>
<p>ART 运行时环境现在可正确实现 newInstance() 方法的访问规则。此变更修正了之前版本中 Dalvik 无法正确检查访问规则的问题。如果您的应用使用 newInstance() 方法，并且您想重写访问检查，请调用 setAccessible() 方法（将输入参数设置为 true）。如果您的应用使用 v7 appcompat 库或 v7 recyclerview 库，则您必须更新应用以使用这些库的最新版本。否则，请务必更新从 XML 引用的任何自定义类，以便能够访问它们的类构造函数。</p>
<p>此版本更新了动态链接程序的行为。动态链接程序现在可以识别库的 soname 与其路径之间的差异（公开错误 6670），并且现在已实现了按 soname 搜索。之前包含错误的 DT_NEEDED 条目（通常是开发计算机文件系统上的绝对路径）却仍工作正常的应用，如今可能会出现加载失败。</p>
<p>现已正确实现 dlopen(3) RTLD_LOCAL 标记。请注意，RTLD_LOCAL 是默认值，因此不显式使用 RTLD_LOCAL 的 dlopen(3) 调用将受到影响（除非您的应用显式使用 RTLD_GLOBAL）。使用 RTLD_LOCAL 时，在随后通过调用 dlopen(3) 加载的库中并不能使用这些符号（这与由 DT_NEEDED 条目引用的情况截然不同）。</p>
<p>在之前版本的 Android 上，如果您的应用请求系统加载包含文本重定位信息的共享库，系统会显示警告，但仍允许加载共享库。从此版本开始，如果您的应用的目标 SDK 版本为 23 或更高，则系统会拒绝加载该库。为帮助您检测库是否加载失败，您的应用应该记录 dlopen(3) 失败日志，并在日志中加入 dlerror(3) 调用返回的问题描述文本。要详细了解如何处理文本重定位，请参阅此指南。</p>
<ul>
<li>APK验证</li>
</ul>
<p>该平台现在执行的 APK 验证更为严格。如果在清单中声明的文件在 APK 中并不存在，该 APK 将被视为已损坏。移除任何内容后必须重新签署 APK。</p>
<h1 id="Android-7-0部分变更行为："><a href="#Android-7-0部分变更行为：" class="headerlink" title="Android 7.0部分变更行为："></a>Android 7.0部分变更行为：</h1><ul>
<li>配置文件指导的 JIT/AOT 编译</li>
</ul>
<p>在 Android 7.0 中，我们添加了即时 (JIT) 编译器，对 ART 进行代码分析，让它可以在应用运行时持续提升 Android 应用的性能。JIT 编译器对 Android 运行组件当前的 Ahead of Time (AOT) 编译器进行了补充，有助于提升运行时性能，节省存储空间，加快应用更新和系统更新速度。</p>
<p>配置文件指导的编译让 Android 运行组件能够根据应用的实际使用以及设备上的情况管理每个应用的 AOT/JIT 编译。例如，Android 运行组件维护每个应用热方法的配置文件，并且可以预编译和缓存这些方法以实现最佳性能。对于应用的其他部分，在实际使用之前不会进行编译。</p>
<p>除提升应用的关键部分的性能外，配置文件指导的编译还有助于减少整个 RAM 占用，包括关联的二进制文件。此功能对于低内存设备非常尤其重要。</p>
<p>Android 运行组件在管理配置文件指导的编译时，可最大程度降低对设备电池的影响。仅当设备处于空闲状态和充电时才进行编译，从而可以通过提前执行该工作节约时间和省电。</p>
<ul>
<li>快速的应用安装路径</li>
</ul>
<p>Android 运行组件的 JIT 编译器最实际的好处之一是应用安装和系统更新的速度。即使在 Android 6.0 中需要几分钟进行优化和安装的大型应用，现在只需几秒钟就可以完成安装。系统更新也变得更快，因为省去了优化步骤</p>
<p><strong>关于JIT的回归</strong></p>
<p>在Android 5.0上，系统在安装APK时会直接将dex文件中的代码编译成机器码。编译一个应用就已经很耗时，若编译所有应用，等待时间将会使人难以忍受。</p>
<p>例如：<br>应用程序编译生成的OAT文件会引用Framework中的代码。一旦系统发生升级，Framework中的实现发生变化，就需要重新修正所有应用程序的OAT文件，使得它们的引用是正确的，这就需要重新编译所有的应用。</p>
<p>由此可以看到单纯的AOT编译会存在以下问题：</p>
<ul>
<li>应用安装时间过长。</li>
<li>系统每次更新都要重新编译所有应用。</li>
<li>编译生成的Oat文件中，既包含了原先的Dex文件，又包含了编译后的机器代码。而实际上，对于用户来说，并非会用到应用程序中的所有功能，因此很多时候编译生成的机器码是一直用不到的。一份数据存在两份结果（尽管它们的格式是不一样的）显然是一种存储空间的浪费。</li>
</ul>
<p>因此，为了解决上述问题，Android 7.0(代号Nougat,简称N)中添加了JIT编译器和配置文件引导型编译。JIT和AOT的配合，是取两者之长，避两者之短：在APK安装时，并不是一次性将所有代码全部编译成机器码。而是在实际运行过程中，对代码进行分析，将热点代码编译成机器码，让它可以在应用运行时持续提升 Android 应用的性能。</p>
<p>JIT编译器补充了ART当前的预先AOT编译器的功能，有助于提高运行时性能，节省存储空间，以及加快应用及系统更新速度。相较于 AOT编译器，JIT编译器的优势也更为明显，因为它不会在应用自动更新期间或重新编译应用（在无线下载 OTA 更新期间）时拖慢系统速度。</p>
<p>尽管JIT和AOT使用相同的编译器，它们所进行的一系列优化也较为相似，但它们生成的代码可能会有所不同。JIT会利用运行时类型信息，可以更高效地进行内联，并可让堆栈替换 OnStackReplacement 编译成为可能，而这一切都会使其生成的代码略有不同。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/26/Android系统版本分布/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Heinz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Heinz Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/26/Android系统版本分布/" itemprop="url">Android系统版本分布</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-26T15:56:56+08:00">
                2018-12-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/12/26/Android系统版本分布/" class="leancloud_visitors" data-flag-title="Android系统版本分布">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Android 信息中心：<a href="https://developer.android.com/about/dashboards/?hl=zh-cn" target="_blank" rel="noopener">https://developer.android.com/about/dashboards/?hl=zh-cn</a></p>
<p>Android各个系统版本市场占有率表：<br><img src="https://note.youdao.com/yws/api/personal/file/WEB9c984ab2b3606d4f688dee72ff7fb30f?method=download&amp;shareKey=288a168344f4c3da4e4930c699d19ee2" alt="image"><br>Android各个系统版本市场占有率图：<br><img src="https://note.youdao.com/yws/api/personal/file/WEB75a72b0c1a2257ce5215bc18bb38a8d4?method=download&amp;shareKey=cc627bcace397474e82ad2ad8355057c" alt="image"></p>
<p>总结，由上表和上图可知：</p>
<ul>
<li>Android6.0、Android7.0,7.1、Android8.0,8.1占据了3/4的Android市场。</li>
<li>单个系统版本市场占有率最高的为Android 6.0，即API 23 </li>
<li>复合系统版本市场占有率最高的为Android 7.0系列，其中7.0为18.1%，7.1为10.1%</li>
<li></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/26/Java-打印堆栈信息/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Heinz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Heinz Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/26/Java-打印堆栈信息/" itemprop="url">Java 打印堆栈信息</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-26T11:41:27+08:00">
                2018-12-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/12/26/Java-打印堆栈信息/" class="leancloud_visitors" data-flag-title="Java 打印堆栈信息">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#java打印堆栈信息</p>
<ul>
<li><p>在函数内部打印函数调用堆栈</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Log.d(TAG,Log.getStackTraceString(new Throwable()));</span><br></pre></td></tr></table></figure>
</li>
<li><p>出异常时打印当前堆栈</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">try&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">catch(Exception e)&#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用StackTraceElement[]打印</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Throwable ex = new Throwable();</span><br><span class="line">StackTraceElement[] stackElements = ex.getStackTrace();</span><br><span class="line">if (stackElements != null) &#123;</span><br><span class="line">    for (int i = 0; i &lt; stackElements.length; i++) &#123;</span><br><span class="line">        System.out.print(stackElements[i].getClassName()+&quot;/t&quot;);</span><br><span class="line">        System.out.print(stackElements[i].getFileName()+&quot;/t&quot;);</span><br><span class="line">        System.out.print(stackElements[i].getLineNumber()+&quot;/t&quot;);</span><br><span class="line">        System.out.println(stackElements[i].getMethodName());</span><br><span class="line">        System.out.println(&quot;-----------------------------------&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用Thread打印</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Thread.currentThread().getStackTrace()</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用exception打印</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Exception e = new Exception(&quot;this is a log&quot;);</span><br><span class="line">e.printStackTrace();</span><br></pre></td></tr></table></figure></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/26/Oat文件分析/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Heinz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Heinz Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/26/Oat文件分析/" itemprop="url">Android Oat文件分析</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-26T11:35:56+08:00">
                2018-12-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/12/26/Oat文件分析/" class="leancloud_visitors" data-flag-title="Android Oat文件分析">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>.oatdata -&gt; .rodata(oatHeader、dex文件相关信息、dex原始文件、类中方法与翻译为native code的对应关系)<br>.oatexec -&gt; .text(native code)</p>
<p>Oat文件结构概览：</p>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEBd91be5da5cc9c70b50ac5355d12d6e84?method=download&amp;shareKey=cfbfd9c6f94f41b648fc4d3b4ebacadb" alt="avatar"></p>
<h1 id="elf文件结构-32位-："><a href="#elf文件结构-32位-：" class="headerlink" title="elf文件结构(32位)："></a>elf文件结构(32位)：</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">typedef uint16_t Elf32_Half; //2 bytes</span><br><span class="line">typedef uint32_t Elf32_Word; //4 bytes</span><br><span class="line">typedef uint32_t Elf32_Addr; //4 bytes</span><br><span class="line">typedef uint32_t Elf32_Off;  //4 bytes</span><br><span class="line">typedef int32_t  Elf32_Sword;//4 bytes</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// Object file magic string.</span><br><span class="line">static const char ElfMagic[] = &#123; 0x7f, &apos;E&apos;, &apos;L&apos;, &apos;F&apos;, &apos;\0&apos; &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// e_ident size and indices.</span><br><span class="line">enum &#123;</span><br><span class="line">  EI_MAG0       = 0,          // File identification index.</span><br><span class="line">  EI_MAG1       = 1,          // File identification index.</span><br><span class="line">  EI_MAG2       = 2,          // File identification index.</span><br><span class="line">  EI_MAG3       = 3,          // File identification index.</span><br><span class="line">  EI_CLASS      = 4          ,// File class.</span><br><span class="line">  EI_DATA       = 5,          // Data encoding.</span><br><span class="line">  EI_VERSION    = 6,          // File version.</span><br><span class="line">  EI_OSABI      = 7,          // OS/ABI identification.</span><br><span class="line">  EI_ABIVERSION = 8,          // ABI version.</span><br><span class="line">  EI_PAD        = 9,          // Start of padding bytes.</span><br><span class="line">  EI_NIDENT     = 16          // Number of bytes in e_ident.</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>elf文件头结构：（16+4+20+12=52字节，1+2+5+6=14项）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">struct Elf32_Ehdr&#123;</span><br><span class="line">    unsigned char e_ident[EI_NIDENT];//ELF文件魔数          16字节</span><br><span class="line">    Elf32_Half  e_type;              //ELF文件类型（32/64位）2字节  2*2</span><br><span class="line">    Elf32_Half  e_machine;           //该ELF文件所需要的架构  2字节</span><br><span class="line">    Elf32_Word  e_version;           //ELF文件版本（始终为1） 4字节   4*5</span><br><span class="line">    Elf32_Addr  e_entry;             //程序入口地址          4字节</span><br><span class="line">    Elf32_Off   e_phoff;             //segment表偏移地址     4字节</span><br><span class="line">    Elf32_Off   e_shoff;             //section表偏移地址     4字节</span><br><span class="line">    Elf32_Word  e_flags;             //标志                 4字节</span><br><span class="line">    Elf32_Half  e_ehsize;            //ELF文件头大小         2字节   2*6</span><br><span class="line">    Elf32_Half  e_phentsize;        //segment表项大小        2字节</span><br><span class="line">    Elf32_Half  e_phnum;            //segment表项数目        2字节</span><br><span class="line">    Elf32_Half  e_shentsize;        //section表项大小        2字节  </span><br><span class="line">    Elf32_Half  e_shnum;            //section表项数目        2字节</span><br><span class="line">    Elf32_Half  e_shstrndx;         //段表字符串表在section表中的下标 2字节</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// File types</span><br><span class="line">enum &#123;</span><br><span class="line">  ET_NONE   = 0,      // No file type</span><br><span class="line">  ET_REL    = 1,      // Relocatable file</span><br><span class="line">  ET_EXEC   = 2,      // Executable file</span><br><span class="line">  ET_DYN    = 3,      // Shared object file</span><br><span class="line">  ET_CORE   = 4,      // Core file</span><br><span class="line">  ET_LOPROC = 0xff00, // Beginning of processor-specific codes</span><br><span class="line">  ET_HIPROC = 0xffff  // Processor-specific</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// Machine architectures</span><br><span class="line">enum &#123;</span><br><span class="line">    EM_NONE = 0, // No machine</span><br><span class="line">    EM_ARM  = 40 // ARM</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>案例分析①：data@<a href="mailto:app@com.example.passerby.myapplication.app-1" target="_blank" rel="noopener">app@com.example.passerby.myapplication.app-1</a>@<a href="mailto:base.apk@classes.dex" target="_blank" rel="noopener">base.apk@classes.dex</a></p>
<blockquote>
<p>7F 45 4C 46 01 01 01 03 00 00 00 00 00 00 00 00<br>03 00 28 00 01 00 00 00 00 00 00 00 34 00 00 00<br>70 50 48 00 00 00 00 05 34 00 20 00 05 00 28 00<br>08 00 07 00</p>
</blockquote>
<p>魔数：7F 45 4C 46 //0x464c457f<br>位宽：01 //0x01代表32位；0x02代表64位<br>端序：01 //0x01代表小端；0x02代表打断<br>版本：01<br>操作系统：03 //0x03代表Linux<br>00 00 00 00 00 00 00 00<br>文件类型：03 00  //0x03:共享文件<br>芯片架构：28 00 // 0x28 ARM架构<br>文件版本：01 00 00 00 //0x01 (始终为1)<br>程序入口地址：00 00 00 00 //0x0<br>segment表偏移：34 00 00 00 //0x34<br>section表偏移：70 50 48 00 //0x485070<br>标志：00 00 00 05   //0x5000000<br>文件头大小：34 00   //0x34<br>segment表项大小：20 00  //0x20<br>segment表项数目：05 00  //0x05<br>section表项大小：28 00  //0x28<br>section表项数目：08 00  //0x08<br>段表字符串表在段表中下标：07 00 //0x07</p>
<hr>
<p>segment头结构：（8项，每项4个字节，32字节）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">struct Elf32_Phdr&#123;</span><br><span class="line">    Elf32_Word  p_type;//segment类型</span><br><span class="line">    Elf32_Off   p_offset;//segment相对文件开始的偏移</span><br><span class="line">    Elf32_Addr  p_vaddr;//segment映射到内存中的首字节地址（即虚拟地址）</span><br><span class="line">    Elf32_Addr  p_paddr;//在物理地址定位有关的系统中，该字段是为该段的物理地址而保留的，对于可执行文件和共享的object而言是未指定内容的。</span><br><span class="line">    Elf32_Word  p_filesz;//在文件映像中该segment的字节数（可能是0）</span><br><span class="line">    Elf32_Word  p_memsz;//在内存映像中该segment的字节数（可能是0）</span><br><span class="line">    Elf32_Word  p_flags;//segment标志</span><br><span class="line">    Elf32_Word  p_align;//可载入的进程段必须有合适的p_vaddr、p_offset值，取页面大小的模。该字段给出了该段在内存和文件中排列值。0和1表示不需要排列。否则，p_align必须为正的2的幂</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// Segment types.</span><br><span class="line">enum &#123;</span><br><span class="line">    PT_NULL    = 0, // Unused segment.空值</span><br><span class="line">    PT_LOAD    = 1, // Loadable segment.加载到内存中</span><br><span class="line">    PT_DYNAMIC = 2, // Dynamic linking information.动态链接</span><br><span class="line">    PT_INTERP  = 3, // Interpreter pathname.动态链接的辅助信息</span><br><span class="line">    PT_NOTE    = 4, // Auxiliary information.其他信息</span><br><span class="line">    PT_SHLIB   = 5, // Reserved.RFU</span><br><span class="line">    PT_PHDR    = 6, // The program header table itself.segment表头的位置和大小</span><br><span class="line">    PT_TLS     = 7, // The thread-local storage template.</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>案例分析②：data@<a href="mailto:app@com.example.passerby.myapplication.app-1" target="_blank" rel="noopener">app@com.example.passerby.myapplication.app-1</a>@<a href="mailto:base.apk@classes.dex" target="_blank" rel="noopener">base.apk@classes.dex</a></p>
<p>由ELF文件头知：segment表偏移为0x34;表大小为0x05;表项大小为0x20;推出segment头表大小为：0x05*0x20=0xa0 </p>
<blockquote>
<p>06 00 00 00 34 00 00 00 34 00 00 00 34 00 00 00 //PT_PHDR<br>A0 00 00 00 A0 00 00 00 04 00 00 00 04 00 00 00<br>01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 //PT_LOAD<br>00 10 2A 00 00 10 2A 00 04 00 00 00 00 10 00 00<br>01 00 00 00 00 10 2A 00 00 10 2A 00 00 10 2A 00 //PT_LOAD<br>48 35 1E 00 48 35 1E 00 05 00 00 00 00 10 00 00<br>01 00 00 00 00 50 48 00 00 50 48 00 00 50 48 00 //PT_LOAD<br>38 00 00 00 38 00 00 00 06 00 00 00 00 10 00 00<br>02 00 00 00 00 50 48 00 00 50 48 00 00 50 48 00 //PT_DYNAMIC<br>38 00 00 00 38 00 00 00 06 00 00 00 00 10 00 00   </p>
</blockquote>
<p>第一个segment头：<br>06 00 00 00 34 00 00 00 34 00 00 00 34 00 00 00<br>A0 00 00 00 A0 00 00 00 04 00 00 00 04 00 00 00<br>segment类型：06 00 00 00    //PT_PHDR(程序头表自身)<br>segment文件偏移：34 00 00 00<br>segment虚拟地址：34 00 00 00<br>segment物理地址：34 00 00 00<br>文件映像中该segment字节数：A0 00 00 00<br>内存映像中该segment字节数：A0 00 00 00<br>segment标志：04 00 00 00<br>segment对齐：04 00 00 00</p>
<p>其他segment头:<br>省略…</p>
<p>section头结构：（10项，每项4个字节，40字节）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">struct Elf32__Shdr&#123;</span><br><span class="line">  Elf32_Word sh_name;      // Section name (index into string table), section名字，string table的索引</span><br><span class="line">  Elf32_Word sh_type;      // Section type (SHT_*),section的类型</span><br><span class="line">  Elf32_Word sh_flags;     // Section flags (SHF_*),section标记，用来描述多个属性</span><br><span class="line">  Elf32_Addr sh_addr;      // Address where section is to be loaded,若该section被加载到内存中，该字段表示其在内存中的位置</span><br><span class="line">  Elf32_Off  sh_offset;    // File offset of section data, in bytes,该section在文件中的偏移，SHT_NOBITS类型的section在文件中不占用空间，概念上的位置</span><br><span class="line">  Elf32_Word sh_size;      // Size of section, in bytes,section大小，SHT_NOBITS类型的section该值可能为非0，但是不占文件空间</span><br><span class="line">  Elf32_Word sh_link;      // Section type-specific header table index link,到section头表的链接</span><br><span class="line">  Elf32_Word sh_info;      // Section type-specific extra information,额外信息</span><br><span class="line">  Elf32_Word sh_addralign; // Section address alignment,地址对齐</span><br><span class="line">  Elf32_Word sh_entsize;   // Size of records contained within the section,一些sections保留着一张固定大小入口的表，对于此类型的section，该字段给除了每个入口的字节大小</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// Section types.</span><br><span class="line">enum &#123;</span><br><span class="line">    SHT_NULL          = 0,  // No associated section (inactive entry).</span><br><span class="line">    SHT_PROGBITS      = 1,  // Program-defined contents.</span><br><span class="line">    SHT_SYMTAB        = 2,  // Symbol table. 符号表</span><br><span class="line">    SHT_STRTAB        = 3,  // String table. 字符串表</span><br><span class="line">    SHT_RELA          = 4,  // Relocation entries; explicit addends.</span><br><span class="line">    SHT_HASH          = 5,  // Symbol hash table.</span><br><span class="line">    SHT_DYNAMIC       = 6,  // Information for dynamic linking.</span><br><span class="line">    SHT_NOTE          = 7,  // Information about the file.</span><br><span class="line">    SHT_NOBITS        = 8,  // Data occupies no space in the file.</span><br><span class="line">    SHT_REL           = 9,  // Relocation entries; no explicit addends.</span><br><span class="line">    SHT_SHLIB         = 10, // Reserved.</span><br><span class="line">    SHT_DYNSYM        = 11, // Symbol table.  动态符号表</span><br><span class="line">    SHT_INIT_ARRAY    = 14, // Pointers to initialization functions.</span><br><span class="line">    SHT_FINI_ARRAY    = 15, // Pointers to termination functions.</span><br><span class="line">    SHT_PREINIT_ARRAY = 16, // Pointers to pre-init functions.</span><br><span class="line">    SHT_GROUP         = 17, // Section group.</span><br><span class="line">    SHT_SYMTAB_SHNDX  = 18, // Indices for SHN_XINDEX entries</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>案例分析③：data@<a href="mailto:app@com.example.passerby.myapplication.app-1" target="_blank" rel="noopener">app@com.example.passerby.myapplication.app-1</a>@<a href="mailto:base.apk@classes.dex" target="_blank" rel="noopener">base.apk@classes.dex</a><br>由ELF文件头知：section表偏移为0x485070;表项大小为0x28;表项数目为0x08;推出section头表大小为0x28*0x08=0x140</p>
<blockquote>
<p>00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00<br>00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00<br>00 00 00 00 00 00 00 00 01 00 00 00 0B 00 00 00<br>02 00 00 00 D4 00 00 00 D4 00 00 00 40 00 00 00<br>02 00 00 00 00 00 00 00 04 00 00 00 10 00 00 00<br>09 00 00 00 03 00 00 00 02 00 00 00 14 01 00 00<br>14 01 00 00 64 00 00 00 00 00 00 00 00 00 00 00<br>01 00 00 00 01 00 00 00 11 00 00 00 05 00 00 00<br>02 00 00 00 78 01 00 00 78 01 00 00 20 00 00 00<br>01 00 00 00 00 00 00 00 04 00 00 00 04 00 00 00<br>17 00 00 00 01 00 00 00 02 00 00 00 00 10 00 00<br>00 10 00 00 00 00 2A 00 00 00 00 00 00 00 00 00<br>00 10 00 00 00 00 00 00 1F 00 00 00 01 00 00 00<br>06 00 00 00 00 10 2A 00 00 10 2A 00 48 35 1E 00<br>00 00 00 00 00 00 00 00 00 10 00 00 00 00 00 00<br>25 00 00 00 06 00 00 00 02 00 00 00 00 50 48 00<br>00 50 48 00 38 00 00 00 01 00 00 00 00 00 00 00<br>00 10 00 00 08 00 00 00 2E 00 00 00 03 00 00 00<br>00 00 00 00 00 00 00 00 38 50 48 00 38 00 00 00<br>00 00 00 00 00 00 00 00 01 00 00 00 01 00 00 00   </p>
</blockquote>
<p>第一个section头：//No associated section (inactive entry).   </p>
<blockquote>
<p>00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00<br>00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00<br>00 00 00 00 00 00 00 00</p>
</blockquote>
<p>第二个section头：(.dynsym) //Symbol table    </p>
<blockquote>
<p>01 00 00 00 0B 00 00 00<br>02 00 00 00 D4 00 00 00 D4 00 00 00 40 00 00 00<br>02 00 00 00 00 00 00 00 04 00 00 00 10 00 00 00   </p>
</blockquote>
<p>section名称：01 00 00 00    //在字符串表中的下标<br>section类型：0B 00 00 00    //0xb 符号表 .symbol    </p>
<p>第三个section头：(.dynstr)</p>
<blockquote>
<p>09 00 00 00 03 00 00 00 02 00 00 00 14 01 00 00<br>14 01 00 00 64 00 00 00 00 00 00 00 00 00 00 00<br>01 00 00 00 01 00 00 00   </p>
</blockquote>
<p>section名称：09 00 00 00<br>section类型：03 00 00 00    //0x3 字符串表 .strtab<br>section标记：02 00 00 00<br>section虚拟地址：14 01 00 00<br>section文件偏移：14 01 00 00 //0x0114<br>section大小：64 00 00 00   //0x64 推出结束偏移：0x178<br>section到section头表的链接：00 00 00 00<br>section额外信息：00 00 00 00<br>section对齐：01 00 00 00<br>section入口表大小：01 00 00 00    </p>
<p>根据section头信息，导出.dynstr内容：    </p>
<blockquote>
<p>00 6F 61 74 64 61 74 61 00 6F 61 74 65 78 65 63<br>00 6F 61 74 6C 61 73 74 77 6F 72 64 00 64 61 74<br>61 40 61 70 70 40 63 6F 6D 2E 65 78 61 6D 70 6C<br>65 2E 70 61 73 73 65 72 62 79 2E 6D 79 61 70 70<br>6C 69 63 61 74 69 6F 6E 2E 61 70 70 2D 31 40 62<br>61 73 65 2E 61 70 6B 40 63 6C 61 73 73 65 73 2E<br>64 65 78 00</p>
</blockquote>
<p>对应的字符信息：<br>索引  |  值<br>—|:–:<br>0x0  |  \00<br>0x1  | oatdata\00<br>0x9  | oatexec\00<br>0x11 | oatlastword\00<br>0x1d | data@<a href="mailto:app@com.example.passerby.myapplication.app-1" target="_blank" rel="noopener">app@com.example.passerby.myapplication.app-1</a>@<a href="mailto:base.apk@classes.dex" target="_blank" rel="noopener">base.apk@classes.dex</a>\00</p>
<p>第四个section头：(.hash)</p>
<blockquote>
<p>11 00 00 00 05 00 00 00<br>02 00 00 00 78 01 00 00 78 01 00 00 20 00 00 00<br>01 00 00 00 00 00 00 00 04 00 00 00 04 00 00 00   </p>
</blockquote>
<p>section名称：11 00 00 00<br>section类型：05 00 00 00    //0x5 符号hash表    </p>
<p>第五个section头：(.rodata)  [原dex信息,oatdata] [oat文件头起始位置]   </p>
<blockquote>
<p>17 00 00 00 01 00 00 00 02 00 00 00 00 10 00 00<br>00 10 00 00 00 00 2A 00 00 00 00 00 00 00 00 00<br>00 10 00 00 00 00 00 00 </p>
</blockquote>
<p>section名称：17 00 00 00<br>section类型：01 00 00 00    //0x1 Program-defined contents<br>section标记：02 00 00 00<br>section虚拟地址：00 10 00 00<br>section文件偏移：00 10 00 00    //0x1000<br>section大小：00 00 2A 00        //0x2A0000 推出结束偏移：0x2A1000<br>section到section头表的链接：00 00 00 00<br>section额外信息：00 00 00 00<br>section对齐：00 10 00 00<br>section入口表大小：00 00 00 00    </p>
<p>依据section头，导出.rodata内容：<br>[rodata.txt]</p>
<p>第六个section头：(.text) [native code,oatexec]    </p>
<blockquote>
<p>1F 00 00 00 01 00 00 00<br>06 00 00 00 00 10 2A 00 00 10 2A 00 48 35 1E 00<br>00 00 00 00 00 00 00 00 00 10 00 00 00 00 00 00  </p>
</blockquote>
<p>section名称：1F 00 00 00<br>section类型：01 00 00 00    //0x1 Program-defined contents<br>section标记：06 00 00 00<br>section虚拟地址：00 10 2A 00<br>section文件偏移：00 10 2A 00    //0x2A1000<br>section大小：48 35 1E 00        //0x1E3548 推出结束偏移：0x484548<br>section到section头表的链接：00 00 00 00<br>section额外信息：00 00 00 00<br>section对齐：00 10 00 00<br>section入口表大小：00 00 00 00    </p>
<p>依据section头信息，导出.text内容：<br>[text.txt]</p>
<p><strong>.text段 与 .dynamic段之间有一段空区域</strong></p>
<p>第七个section头：(.dynamic)      </p>
<blockquote>
<p>25 00 00 00 06 00 00 00 02 00 00 00 00 50 48 00<br>00 50 48 00 38 00 00 00 01 00 00 00 00 00 00 00<br>00 10 00 00 08 00 00 00     </p>
</blockquote>
<p>section名称：25 00 00 00<br>section类型：06 00 00 00    //Information for dynamic linking<br>section标记：02 00 00 00<br>section虚拟地址：00 50 48 00<br>section文件偏移：00 50 48 00    //0x485000<br>section大小：38 00 00 00        //0x38 推出结束偏移：0x485038<br>section到section头表的链接：01 00 00 00<br>section额外信息：00 00 00 00<br>section对齐：00 10 00 00<br>section入口表大小：08 00 00 00    </p>
<p>第八个section头：(.shstrtab)：<br>由ELF文件头知：shstrtab在section头表总的下标为0x07,在本案例中即最后一个section </p>
<blockquote>
<p>2E 00 00 00 03 00 00 00<br>00 00 00 00 00 00 00 00 38 50 48 00 38 00 00 00<br>00 00 00 00 00 00 00 00 01 00 00 00 01 00 00 00   </p>
</blockquote>
<p>section名称：2E 00 00 00<br>section类型：03 00 00 00    //字符串表（段表字符串表）<br>section标记：00 00 00 00<br>section虚拟地址：00 00 00 00<br>section文件偏移：38 50 48 00    //0x485038<br>section大小：38 00 00 00        //0x38 推出结束偏移：0x485070<br>section到section头表的链接：00 00 00 00<br>section额外信息：00 00 00 00<br>section对齐：01 00 00 00<br>section入口表大小：01 00 00 00    </p>
<p>依据section头信息，导出.shstrtab内容：    </p>
<blockquote>
<p>00 2E 64 79 6E 73 79 6D 00 2E 64 79 6E 73 74 72<br>00 2E 68 61 73 68 00 2E 72 6F 64 61 74 61 00 2E<br>74 65 78 74 00 2E 64 79 6E 61 6D 69 63 00 2E 73<br>68 73 74 72 74 61 62 00</p>
</blockquote>
<p>对应的字符信息：<br>索引  |  值<br>—|:–:<br>0x0  |  \00<br>0x01 |  .dynsym\00<br>0x09 |  .dynstr\00<br>0x11 |  .hash\00<br>0x17 |  .rodata\00<br>0x1f |  .text\00<br>0x25 |  .dynamic\00<br>0x2e |  .shstrtab\00</p>
<hr>
<p>oat文件头结构：/art/runtime/oat.h<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">class PACKED(4) OatHeader &#123;</span><br><span class="line">    ...</span><br><span class="line"> private:</span><br><span class="line">  ...</span><br><span class="line">  uint8_t magic_[4];    //魔数‘oat\n’</span><br><span class="line">  uint8_t version_[4];  //oat文件版本号</span><br><span class="line">  uint32_t adler32_checksum_;   //校验和</span><br><span class="line"></span><br><span class="line">  InstructionSet instruction_set_;  //本地机器指令集，表示指令的类型（枚举类型）/art/runtime/instruction_set.h</span><br><span class="line">  InstructionSetFeatures instruction_set_features_; //架构特性</span><br><span class="line">  uint32_t dex_file_count_; //oat文件包含的dex文件个数</span><br><span class="line">  uint32_t executable_offset_;  //oatexec段开始位置与oatdata段开始位置的偏移值（oatexec段开始位置+executable_offset_=oatdata段开始位置）</span><br><span class="line"></span><br><span class="line">  uint32_t interpreter_to_interpreter_bridge_offset_;   //用来从解释器调用另外一个也是通过解释器来执行的类方法的trampoline代码的偏移位置</span><br><span class="line">  uint32_t interpreter_to_compiled_code_bridge_offset_; //用来从解释器调用另外一个通过本地机器指令执行的类方法的trampoline代码的偏移位置</span><br><span class="line">  uint32_t jni_dlsym_lookup_offset_;    //类方法在执行过程中，若被调用的方法是JNI函数，那么通过存放在此位置的trampoline代码来调用</span><br><span class="line">  uint32_t portable_imt_conflict_trampoline_offset_;    //...</span><br><span class="line">  uint32_t portable_resolution_trampoline_offset_;  //用来在运行时解析还未链接的类方法的trampoline代码位置（portable类型的机器指令）</span><br><span class="line">  uint32_t portable_to_interpreter_bridge_offset_;  //用来从本地机器指令（portable类型）调用另外一个通过解释器解释执行的类方法的trampoline代码的偏移位置</span><br><span class="line">  uint32_t quick_generic_jni_trampoline_offset_;    //...</span><br><span class="line">  uint32_t quick_imt_conflict_trampoline_offset_;   //...</span><br><span class="line">  uint32_t quick_resolution_trampoline_offset_; //用来在运行时解析还未链接的类方法的trampoline代码位置（quick类型的机器指令）</span><br><span class="line">  uint32_t quick_to_interpreter_bridge_offset_;  //用来从本地机器指令（quick类型）调用另外一个通过解释器解释执行的类方法的trampoline代码的偏移位置</span><br><span class="line"></span><br><span class="line">  //由于每一个应用程序都会依赖于boot.art文件，上述10个变量指向的trampoline代码段只存在于boot.art文件中，即在应用程序classes.dex生成的oat文件的oatdata段头部，上述变量值均为0</span><br><span class="line"></span><br><span class="line">  // The amount that the image this oat is associated with has been patched.</span><br><span class="line">  int32_t image_patch_delta_;   //该oat文件关联的image被patch的数量</span><br><span class="line"></span><br><span class="line">  uint32_t image_file_location_oat_checksum_;   //用来创建image空间的oat文件的校验和</span><br><span class="line">  uint32_t image_file_location_oat_data_begin_; //用来创建image空间的oat文件的oatdata段在内存的位置</span><br><span class="line"></span><br><span class="line">  uint32_t key_value_store_size_;   //用来创建image空间的文件路径的大小</span><br><span class="line">  uint8_t key_value_store_[0];  // note variable width data at end</span><br><span class="line"></span><br><span class="line">  DISALLOW_COPY_AND_ASSIGN(OatHeader);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// InstructionSet</span><br><span class="line">enum InstructionSet &#123;</span><br><span class="line">  kNone,</span><br><span class="line">  kArm,</span><br><span class="line">  kArm64,</span><br><span class="line">  kThumb2,</span><br><span class="line">  kX86,</span><br><span class="line">  kX86_64,</span><br><span class="line">  kMips,</span><br><span class="line">  kMips64</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>案例分析④：data@<a href="mailto:app@com.example.passerby.myapplication.app-1" target="_blank" rel="noopener">app@com.example.passerby.myapplication.app-1</a>@<a href="mailto:base.apk@classes.dex" target="_blank" rel="noopener">base.apk@classes.dex</a></p>
<p>开始位置：0x1000<br>由rodata.txt中的数据及oat文件头结构知：<br>魔数：6F 61 74 0A   //大端序，0x6f61740a<br>版本号：30 33 39 00 //大端序，0x30333900<br>校验和：E4 E3 11 75<br>指令类型：03 00 00 00<br>指令集特性：01 00 00 00<br>包含的dex文件个数：01 00 00 00<br>oatexec段开始位置相对于oatdata段开始位置的偏移：00 00 2A 00<br>解释器执行到解释器执行的trampoline代码的偏移位置：00 00 00 00<br>解释器执行到本地机器指令执行的trampoline代码的偏移位置：00 00 00 00<br>JNI方法调用的trampoline代码的偏移位置：00 00 00 00<br>portable_imt_conflict_trampoline_offset_：00 00 00 00<br>本地机器指令（portable）执行解析未链接的方法的trampoline代码的偏移位置：00 00 00 00<br>本地机器指令（portable）执行到解释器执行的trampoline代码的偏移位置：00 00 00 00<br>quick_generic_jni_trampoline_offset_：00 00 00 00<br>quick_imt_conflict_trampoline_offset_：00 00 00 00<br>本地机器指令（quick）执行解析未链接的方法的trampoline代码的偏移位置：00 00 00 00<br>本地机器指令（quick）执行到解释器执行的trampoline代码的偏移位置：00 00 00 00<br>image_patch_delta_：00 00 00 00<br>创建image空间的oat文件的校验和：8E 72 EE 60<br>创建image空间的oat文件的oatdata段在内存的位置：00 F0 17 71<br>key_value_store_size_：A6 01 00 00<br>key_value_store_：(dex2oat的参数)   </p>
<p>依据key_value_store_size_导出key_value_store_的内容：   </p>
<blockquote>
<p>64 65 78 32 6F 61 74 2D 63 6D 64 6C 69 6E 65 00<br>2D 2D 7A 69 70 2D 66 64 3D 36 20 2D 2D 7A 69 70<br>2D 6C 6F 63 61 74 69 6F 6E 3D 2F 64 61 74 61 2F<br>61 70 70 2F 63 6F 6D 2E 65 78 61 6D 70 6C 65 2E<br>70 61 73 73 65 72 62 79 2E 6D 79 61 70 70 6C 69<br>63 61 74 69 6F 6E 2E 61 70 70 2D 31 2F 62 61 73<br>65 2E 61 70 6B 20 2D 2D 6F 61 74 2D 66 64 3D 37<br>20 2D 2D 6F 61 74 2D 6C 6F 63 61 74 69 6F 6E 3D<br>2F 64 61 74 61 2F 64 61 6C 76 69 6B 2D 63 61 63<br>68 65 2F 61 72 6D 2F 64 61 74 61 40 61 70 70 40<br>63 6F 6D 2E 65 78 61 6D 70 6C 65 2E 70 61 73 73<br>65 72 62 79 2E 6D 79 61 70 70 6C 69 63 61 74 69<br>6F 6E 2E 61 70 70 2D 31 40 62 61 73 65 2E 61 70<br>6B 40 63 6C 61 73 73 65 73 2E 64 65 78 20 2D 2D<br>69 6E 73 74 72 75 63 74 69 6F 6E 2D 73 65 74 3D<br>61 72 6D 20 2D 2D 69 6E 73 74 72 75 63 74 69 6F<br>6E 2D 73 65 74 2D 66 65 61 74 75 72 65 73 3D 64<br>69 76 20 2D 2D 72 75 6E 74 69 6D 65 2D 61 72 67<br>20 2D 58 6D 73 36 34 6D 20 2D 2D 72 75 6E 74 69<br>6D 65 2D 61 72 67 20 2D 58 6D 78 35 31 32 6D 00<br>64 65 78 32 6F 61 74 2D 68 6F 73 74 00 41 72 6D<br>00 69 6D 61 67 65 2D 6C 6F 63 61 74 69 6F 6E 00<br>2F 64 61 74 61 2F 64 61 6C 76 69 6B 2D 63 61 63<br>68 65 2F 61 72 6D 2F 73 79 73 74 65 6D 40 66 72<br>61 6D 65 77 6F 72 6B 40 62 6F 6F 74 2E 61 72 74<br>00 78 70 6F 73 65 64 2D 6F 61 74 2D 76 65 72 73<br>69 6F 6E 00 32 00</p>
</blockquote>
<p>对应的字符信息：</p>
<p>dex2oat-cmdline\00<br>–zip-fd=6    –zip-location=/data/app/com.example.passerby.myapplication.app-1/base.apk –oat-fd=7     --oat-location=/data/dalvik-cache/arm/data@<a href="mailto:app@com.example.passerby.myapplication.app-1" target="_blank" rel="noopener">app@com.example.passerby.myapplication.app-1</a>@<a href="mailto:base.apk@classes.dex" target="_blank" rel="noopener">base.apk@classes.dex</a> –instruction-set=arm –instruction-set-features=div –runtime-arg -Xms64m –runtime-arg -Xmx512m\00<br>dex2oat-host\00<br>Arm\00<br>image-location\00<br>/data/dalvik-cache/arm/system@<a href="mailto:framework@boot.art" target="_blank" rel="noopener">framework@boot.art</a>\00<br>xposed-oat-version\00<br>2\    </p>
<p>OatHeader后就是Dex文件相关信息(开始位置:0x11FA):<br>根据OatHeader中dex_file_count_的值可知，此处共包含1个Dex文件的内容。<br>若用DexMetaData结构表示Dex文件的内容，其包含的字段如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">uint32_t dex_file_location_size;     //dex文件路径的字节数(4字节)    </span><br><span class="line">char* dex_file_location_data;        //dex文件的路径    </span><br><span class="line">uint32_t dex_file_checksum;          //dex文件的校验和(4字节)    </span><br><span class="line">uint32_t dex_file_offset;            //dex文件相对于oatdata段开始地址的偏移(4字节)   </span><br><span class="line">const uint32_t* methods_offsets_pointer;//是一个数组，元素共有class_defs_size（dex中类的数目）个，该数组的索引与dex中类的索引是一致的，</span><br><span class="line">                                        即第0个类对应methods_offsets_pointer[0],元素的值是相对于oatdata段开始地址的偏移，</span><br><span class="line">                                        比如dex中第0个类对应的OatClass在文件中的开始地址=methods_offsets_pointer[0]+oatdata段开始地址。</span><br></pre></td></tr></table></figure></p>
<p>所以，整个DexMetaData的字节数=OatHeader-&gt;dex_file_count_ <em> (4+dex_file_location_data+4+4+4</em>dex-&gt;class_defs_size)<br>                          = OatHeader-&gt;dex_file_count_ <em> (12+ dex_file_location_data + 4 </em> dex-&gt;class_defs_size)</p>
<p>案例分析⑤：data@<a href="mailto:app@com.example.passerby.myapplication.app-1" target="_blank" rel="noopener">app@com.example.passerby.myapplication.app-1</a>@<a href="mailto:base.apk@classes.dex" target="_blank" rel="noopener">base.apk@classes.dex</a></p>
<p>根据OatHeader的结束位置导出Dex文件信息(0x11FA)：   </p>
<blockquote>
<p>3B 00 00 00 2F 64<br>61 74 61 2F 61 70 70 2F 63 6F 6D 2E 65 78 61 6D<br>70 6C 65 2E 70 61 73 73 65 72 62 79 2E 6D 79 61<br>70 70 6C 69 63 61 74 69 6F 6E 2E 61 70 70 2D 31<br>2F 62 61 73 65 2E 61 70 6B 7C 2B D8 F3 7C 18 00<br>00 4C 23 22 00 58 23 22 00 6C 23 22 00 80 23 22<br>00 9C 23 22 00 A0 23 22 00 D4 23 22 00 D8 23 22<br>00 4C 24 22 00 50 24 22 00 6C 24 22 00 90 24 22<br>00 CC 24 22 00 E0 24 22 00 F4 24 22 00 40 25 22<br>00 44 25 22 00 48 25 22 00 6C 25 22 00 98 25 22<br>….</p>
</blockquote>
<p>dex文件路径的字节数：3B 00 00 00  //0x3B = 3*16+11个字节<br>dex文件路径：<br>2F 64 61 74 61 2F 61 70 70 2F 63 6F 6D 2E 65 78<br>61 6D 70 6C 65 2E 70 61 73 73 65 72 62 79 2E 6D<br>79 61 70 70 6C 69 63 61 74 69 6F 6E 2E 61 70 70<br>2D 31 2F 62 61 73 65 2E 61 70 6B    </p>
<p>对应的字符信息：    /data/app/com.example.passerby.myapplication.app-1/base.apk<br>dex文件校验和：7C 2B D8 F3<br>dex文件相对于oatdata段开始地址的偏移：7C 18 00 00   //0x187c  相对于oat文件的偏移：0x1000 + 0x187c = 0x287c   </p>
<p>methods_offsets_pointer:（每项4个字节，共class_defs_size项，即1422项，结束位置：0x1241+1422*4 = 0x2879）    </p>
<blockquote>
<p>4C 23 22 00 58 23 22 00 6C 23 22 00 80 23 22 00<br>9C 23 22 00 A0 23 22 00 D4 23 22 00 D8 23 22 00<br>4C 24 22 00 50 24 22 00 6C 24 22 00 90 24 22 00<br>CC 24 22 00 E0 24 22 00 F4 24 22 00 40 25 22 00<br>44 25 22 00 48 25 22 00 6C 25 22 00 98 25 22<br>…<br>00 C0 7D 23 00 C4 7E 23 00 00</p>
</blockquote>
<p>根据dex文件地址(0x287c-0x2A1000)导出数据：<br>64 65 78 0A 30 33 35 00 39 DD DD F3 29 80 26 28<br>9E D5 51 3F A1 2B 09 1A 7D D4 6F F8 80 20 96 4C<br>D0 0A 22 00 70 00 00 00 78 56 34 12 00 00 00 00<br>00 00 00 00 F4 09 22 00 19 53 00 00 70 00 00 00<br>87 08 00 00 D4 4C 01 00 51 0D 00 00 F0 6E 01 00<br>B0 3A 00 00 BC 0E 02 00 DF 3E 00 00 3C E4 03 00<br>8E 05 00 00 34 DB 05 00 DC 7D 1B 00 F4 8C 06 00<br>…</p>
<p>可以看到dex文件的文件头：<br>魔数：64 65 78 0A 30 33 35 00  //对应的字符信息dex.035<br>dex文件校验和：39 DD DD F3<br>dex文件sha1签名：29 80 26 28 9E D5 51 3F A1 2B 09 1A 7D D4 6F F8 80 20 96 4C<br>dex文件大小：D0 0A 22 00        //0x220AD0 推出文件结束地址： 0x287c + 0x220ad0 = 0x22334c<br>文件头大小：70 00 00 00         //0x70<br>字节序：78 56 34 12            //0x12345678 小端序<br>link_size_:00 00 00 00<br>link_off_:00 00 00 00<br>map_off_:F4 09 22 00<br>string_ids_size_:19 53 00 00<br>string_ids_off_:70 00 00 00<br>type_ids_size_:87 08 00 00<br>type_ids_off_:D4 4C 01 00<br>proto_ids_size_:51 0D 00 00<br>proto_ids_off_:F0 6E 01 00<br>field_ids_size_:B0 3A 00 00<br>fields_ids_off_:BC 0E 02 00<br>method_ids_size_:DF 3E 00 00<br>methods_ids_off_:3C E4 03 00<br>class_defs_size_:8E 05 00 00    //0x058E,1422,dex文件中共包含1422个类定义<br>class_defs_off_:34 DB 05 00     //0x05db34,相对于dex文件头的偏移位置，相对于oat文件的偏移：0x05db34+0x287c=0x0603b0<br>data_size_:DC 7D 1B 00<br>data_off_:F4 8C 06 00   </p>
<p>案例分析⑥：data@<a href="mailto:app@com.example.passerby.myapplication.app-1" target="_blank" rel="noopener">app@com.example.passerby.myapplication.app-1</a>@<a href="mailto:base.apk@classes.dex" target="_blank" rel="noopener">base.apk@classes.dex</a>   </p>
<p>使用dextra工具导出该oat文件中的dex或手动选中dex文件地址范围保存：（采用export的方式导出010的dex模板会识别不了，应该是导 出的格式有问题;下面所说的偏移都是相对于导出dex文件的偏移）<br>在010工具的type_ids中查找MainActivity，找到对应的索引号1925，转为16进制即：85 07 00 00 ，在010中全局搜索’85 07 00 00‘，找到MainActivity类定义偏移0x68cd4。<br>借助dex分析模板，找到mainActivity类定义的偏移位置：0x068cd4,由DexClassDef结构知，每个DexClassDef大小为32个字节    </p>
<blockquote>
<p>85 07 00 00 01 00 00 00 14 05 00 00 00 00 00 00<br>3E 16 00 00 00 00 00 00 5A 9C 20 00 00 00 00 00   </p>
</blockquote>
<p>类类型：85 07 00 00     //0x0785，指向type_ids的索引<br>访问标志：01 00 00 00   //0x1，public<br>父类类型：14 05 00 00   //0x0514，指向type_ids的索引<br>接口偏移：00 00 00 00   //0x0，指向type_ids的索引，class不为interface,此项值为0<br>源文件名：3E 16 00 00   //0x163e，指向string_ids的索引,string_ids[5094]，MainActivity.java<br>注解偏移：00 00 00 00   //0x0，指向DexAnnotationsDirectoryItem结构，若无此项内容，该值为0<br>类数据偏移：5A 9C 20 00 //0x209c5a，指向DexClassData结构的偏移<br>类静态数据偏移：00 00 00 00 //0x0，指向DexEncodedArray结构的偏移    </p>
<p>查看类数据：（0x209c5a）  </p>
<blockquote>
<p>00 02 01 02 8D 67 00 01 00 9B 79 81 80 04 8C E8<br>4B 9C 79 01 A4 E8 4B 02 04 80 E9 4B 03 04 00 04<br>01 04 02 02 04 02 04 01 02 1E 04 FF 01 37 6C 21<br>01 37 6D 21 04 04 05 04 03 04 02 04 04 0C 64 27<br>00 02 7F 64 7A 00 02 7F 64 7C 00 02 7F 64 7D 00<br>02 7F 64 7E 00 02 7F 64 7F 00 02 7F 64 80 00 02<br>7F 64 81 00 02 7F 64 82 00 02 7F 64 83 00 02 7F<br>64 84 00 02 7F 64<br>…<br>classDataHeader:<br>静态字段个数：0<br>实例字段个数：2<br>非虚方法：1<br>虚方法：2</p>
</blockquote>
<p>字段：…</p>
<p>非虚方法：…</p>
<p>虚方法：…</p>
<p>由该MainActivity类定义的偏移位置和class_defs_off偏移位置知：<br>(0x68cd4-0x5db34)/32=1421,即MainActivity是dex文件中第1422个类定义，在类定义列表中的下标为1421<br>对应methods_offsets_pointer[1421]</p>
<p>methods_offsets_pointer[1421]:C4 7E 23 00   //0X237EC4,该类对应的OatClass相对于oatdata的偏移<br>推出MainActivity对应的OatClass在文件中的偏移：0x237ec4+0x1000 = 0x238ec4   </p>
<p>MainActivity对应的OatClass:(一个direct方法，一个virtual方法)   </p>
<blockquote>
<p>08 00 00 00 B9 31 48 00 E0 7E 23 00 11 32 48 00<br>EF 5A 27 00 61 33 48 00 23 5B 27 00 09 00 03 00<br>28 01 3A 00 08 01 09 00 05 00 36 07 2C 07 48 00<br>08 06 24 06 09 00 06 00 62 00 34 06 08 06 24 06<br>3E 06 5A 06 09 00 03 00 5A 00 2C 07 08 07 09 00<br>0A 00 82 7A 9E 7A BC 00 C4 00 D6 00 CE 62 94 7A<br>72 6A 08 60 78 7A 00 00 00 00 09 00<br>…</p>
</blockquote>
<p>//TODO<br>status:08 00  //kStatusVerified<br>type:00 00    //kOatClassAllCompiled(没有bitmap结构)<br>OatMethodOffSets[0]:B9 31 48 00 E0 7E 23 00<br>OatMethodOffSets[1]:11 32 48 00 EF 5A 27 00<br>…</p>
<p>OatClass结构分析：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">//art/runtime/oat_file.h</span><br><span class="line">class OatClass &#123;</span><br><span class="line">    ...</span><br><span class="line">    private:</span><br><span class="line">    OatClass(</span><br><span class="line">        const OatFile* oat_file,</span><br><span class="line">        mirror::Class::Status status,</span><br><span class="line">        OatClassType type,</span><br><span class="line">        uint32_t bitmap_size,</span><br><span class="line">        const uint32_t* bitmap_pointer,</span><br><span class="line">        const OatMethodOffsets* methods_pointer</span><br><span class="line">    );</span><br><span class="line">    const OatFile*  oat_file_;</span><br><span class="line">    mirror::Class:Status status_;    //2 bytes</span><br><span class="line">    OatClassType type_;  //2 byes</span><br><span class="line">    const uint32_t* bitmap_;</span><br><span class="line">    const OatMethodOffsets* methods_pointer_;//方法的偏移数组，指向相应的native code，4bytes，OatMethodOffset的个数是该类被编译为native code的个数</span><br><span class="line">    friend class OatDexFile;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// art/runtime/mirror/class.h</span><br><span class="line"> enum Status &#123;</span><br><span class="line">    kStatusRetired = -2,</span><br><span class="line">    kStatusError = -1,</span><br><span class="line">    kStatusNotReady = 0,</span><br><span class="line">    kStatusIdx = 1,  // Loaded, DEX idx in super_class_type_idx_ and interfaces_type_idx_.</span><br><span class="line">    kStatusLoaded = 2,  // DEX idx values resolved.</span><br><span class="line">    kStatusResolving = 3,  // Just cloned from temporary class object.</span><br><span class="line">    kStatusResolved = 4,  // Part of linking.</span><br><span class="line">    kStatusVerifying = 5,  // In the process of being verified.</span><br><span class="line">    kStatusRetryVerificationAtRuntime = 6,  // Compile time verification failed, retry at runtime.</span><br><span class="line">    kStatusVerifyingAtRuntime = 7,  // Retrying verification at runtime.</span><br><span class="line">    kStatusVerified = 8,  // Logically part of linking; done pre-init.</span><br><span class="line">    kStatusInitializing = 9,  // Class init in progress.</span><br><span class="line">    kStatusInitialized = 10,  // Ready to go.</span><br><span class="line">    kStatusMax = 11,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// art/runtime/oat.h （OatClass类型不一样，methods_pointer_数组中的偏移位置的计算方式不一样）</span><br><span class="line">enum OatClassType &#123;</span><br><span class="line">  kOatClassAllCompiled = 0,   // OatClass is followed by an OatMethodOffsets for each method.</span><br><span class="line">  kOatClassSomeCompiled = 1,  // A bitmap of which OatMethodOffsets are present follows the OatClass.</span><br><span class="line">  kOatClassNoneCompiled = 2,  // All methods are interpretted so no OatMethodOffsets are necessary.</span><br><span class="line">  kOatClassMax = 3,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// art/runtime/oat.h</span><br><span class="line">class PACKED(4) OatMethodOffsets &#123;</span><br><span class="line"> public:</span><br><span class="line">  OatMethodOffsets();</span><br><span class="line"></span><br><span class="line">  OatMethodOffsets(uint32_t code_offset,</span><br><span class="line">                   uint32_t gc_map_offset);</span><br><span class="line"></span><br><span class="line">  ~OatMethodOffsets();</span><br><span class="line"></span><br><span class="line">  uint32_t code_offset_;//native code相对于oatdata段的偏移</span><br><span class="line">  uint32_t gc_map_offset_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>// OatMethodOffsets 计算方法<br>//函数参数method_idx是方法在dex表示的类中的偏移，比如类的第0个方法method_index为0，第一个方法为method_index为1，依次类推。<br>由于在OatClass中没有保存类中方法的数目，因而没有检查method_index的边界。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">const OatMethodOffsets* OatFile::OatClass::GetOatMethodOffsets(uint32_t method_index) const &#123;</span><br><span class="line">  // NOTE: We don&apos;t keep the number of methods and cannot do a bounds check for method_index.</span><br><span class="line">  if (methods_pointer_ == nullptr) &#123;//没有编译成native code</span><br><span class="line">    CHECK_EQ(kOatClassNoneCompiled, type_);</span><br><span class="line">    return nullptr;</span><br><span class="line">  &#125;</span><br><span class="line">  size_t methods_pointer_index;</span><br><span class="line">  if (bitmap_ == nullptr) &#123;//该类所有方法被编译成native code</span><br><span class="line">    CHECK_EQ(kOatClassAllCompiled, type_);</span><br><span class="line">    methods_pointer_index = method_index;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    CHECK_EQ(kOatClassSomeCompiled, type_);</span><br><span class="line">    if (!BitVector::IsBitSet(bitmap_, method_index)) &#123;//该方法没有对应的native code</span><br><span class="line">      return nullptr;</span><br><span class="line">    &#125;</span><br><span class="line">    size_t num_set_bits = BitVector::NumSetBits(bitmap_, method_index);//使用bitmap记录哪些方法被编译成了native code</span><br><span class="line">    methods_pointer_index = num_set_bits;//找到相应的索引</span><br><span class="line">  &#125;</span><br><span class="line">  const OatMethodOffsets&amp; oat_method_offsets = methods_pointer_[methods_pointer_index];</span><br><span class="line">  return &amp;oat_method_offsets;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//art/runtime/base/bit_vector.cc</span><br><span class="line">uint32_t BitVector::NumSetBits(const uint32_t* storage, uint32_t end) &#123;</span><br><span class="line">  uint32_t word_end = end &gt;&gt; 5; // end/32</span><br><span class="line">  uint32_t partial_word_bits = end &amp; 0x1f;// end%32</span><br><span class="line"></span><br><span class="line">  uint32_t count = 0u;// 为1的位的数目</span><br><span class="line">  for (uint32_t word = 0u; word &lt; word_end; word++) &#123;//先算前word_end个字中为1的位的数目，再算不满一个字的前partial_word_bits位中为1的位的数目</span><br><span class="line">    count += POPCOUNT(storage[word]);</span><br><span class="line">  &#125;</span><br><span class="line">  if (partial_word_bits != 0u) &#123;</span><br><span class="line">    count += POPCOUNT(storage[word_end] &amp; ~(0xffffffffu &lt;&lt; partial_word_bits));</span><br><span class="line">  &#125;</span><br><span class="line">  return count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Bitmap的作用：</p>
<ul>
<li>Bitmaps are used to represent which methods are compiled.</li>
<li>Each bit represents every method in the class ,starting with direct methods,then virtual methods.</li>
<li>If bit it is set,the method is compiled.</li>
</ul>
<p>从OatClass中获取指定方法的native code时，返回的是OatMethod对象，源码如下：<br>/art/runtime/oat_file.cc<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//method_index描述的是目标方法在类中的编号</span><br><span class="line">const OatFile::OatMethod OatFile::OatClass::GetOatMethod(uint32_t method_index) const &#123;</span><br><span class="line">  const OatMethodOffsets* oat_method_offsets = GetOatMethodOffsets(method_index);//获取方法偏移</span><br><span class="line">  if (oat_method_offsets == nullptr) &#123;</span><br><span class="line">    return OatMethod(nullptr, 0, 0);</span><br><span class="line">  &#125;</span><br><span class="line">  if (oat_file_-&gt;IsExecutable() ||</span><br><span class="line">      Runtime::Current() == nullptr ||        // This case applies for oatdump.</span><br><span class="line">      Runtime::Current()-&gt;IsCompiler()) &#123;</span><br><span class="line">    return OatMethod(</span><br><span class="line">        oat_file_-&gt;Begin(),</span><br><span class="line">        oat_method_offsets-&gt;code_offset_,</span><br><span class="line">        oat_method_offsets-&gt;gc_map_offset_);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    // We aren&apos;t allowed to use the compiled code. We just force it down the interpreted version.</span><br><span class="line">    return OatMethod(oat_file_-&gt;Begin(), 0, 0);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/art/runtime/oat_file.h</span><br><span class="line">class OatMethod&#123;</span><br><span class="line">    public:</span><br><span class="line">    ...</span><br><span class="line">    OatMethod(</span><br><span class="line">        const byte* base,</span><br><span class="line">        const uint32_t code_offset,</span><br><span class="line">        const uint32_t gc_map_offset</span><br><span class="line">    );</span><br><span class="line">    OatMethod()&#123;&#125;</span><br><span class="line">    private:</span><br><span class="line">    ...</span><br><span class="line">    const byte* begin_; //oatdata段开始位置</span><br><span class="line">    uint32_t code_offset_;  //OatMethodOffsets-&gt;code_offset_</span><br><span class="line">    uint32_t native_gc_map_offset_;</span><br><span class="line">    friend class OatClass;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>然后就可以通过OatMethod来定位到方法的native code了（begin_+code_offset_）。</p>
<p>总结：  </p>
<ul>
<li>Oat文件其实就是类型为shared object 的Elf文件，首先有一个Elf Header，Elf Header中e_phoff字段指向了program header talbe，e_shoff字段指向了section header table；</li>
<li>section header table中有一个名字为.dynsym的section head，该section head描述的section是符号表；</li>
<li>Oat文件导出了3个符号：oatdata，oatexec，oatlastword；</li>
<li>oatdata指向oatdata段，该区域存的是只读数据，包括 OatHeader，dex相关信息，dex类中方法与native code的映射关系（由 OatClass表示），通过OatClass可以找到对应方法的native code；</li>
<li>oatexec指向oatexec段，该区域存的是方法的native code，是可执行的；</li>
<li>oatlastword指向oatexec段的最后一个字的开始地址。即oatexec段的结束地址=oatlastword-&gt;st_value+3。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/23/hello-world/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Heinz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Heinz Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/23/hello-world/" itemprop="url">Hello World</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-23T11:46:55+08:00">
                2018-12-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/12/23/hello-world/" class="leancloud_visitors" data-flag-title="Hello World">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Heinz">
            
              <p class="site-author-name" itemprop="name">Heinz</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">20</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/itmayi" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:799902881@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Heinz</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>



        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  





  
  







  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/three.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/canvas_lines.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("jypPJXy89LBDsg88boqicDg9-gzGzoHsz", "7z1xPLru7WIRw9p0A6SE779N");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
